<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BUMFY</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@450;600;800;900&family=Space+Mono:wght@400;700&family=JetBrains+Mono:wght@400;700;800&family=Unbounded:wght@200..900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" referrerpolicy="no-referrer"/>

  <style>
    :root{
      --bg:#0b0c0f;
      --surface:#0f1116;
      --surface2:#0c0e12;
      --ink:#e9e9ea;
      --muted:#b4b4b1;
      --line:rgba(255,255,255,.14);
      --line2:rgba(255,255,255,.08);
      --accent:#e06a6a;
      --ok:#3bdc94;
      --bad:#ff5f68;
      --warn:#ffd166;
      --pos:#123019;
      --neg:#2b1214;
      --mono: "JetBrains Mono", "Space Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --brand: "JetBrains Mono", "Space Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --pad:12px;
      --bar:72px;
      --foot:var(--bar);
      --edge:0px;
      --focus: 0 0 0 3px color-mix(in oklab, var(--accent), transparent 84%);
      --font: 16px;
      --framebar-bg: color-mix(in oklab, var(--surface2), var(--bg) 35%);
      --vram-fill: rgba(255,255,255,.28);
      --vram-fill-hot: color-mix(in oklab, var(--bad), transparent 12%);
      --cache-btn: #f2e5a2;
      --cache-btn-ok: #b9e7bf;
    }
    [data-theme="light"]{
      --bg:#f2eee7;
      --surface:#f8f4ee;
      --surface2:#efe8de;
      --ink:#1d1c1a;
      --muted:#5f6066;
      --line:rgba(0,0,0,.12);
      --line2:rgba(0,0,0,.08);
      --accent:#c96555;
      --pos:#d3efe1;
      --neg:#f3d9dc;
    }
    [data-theme="dark"]{
      --bg:#0b0c0f;
      --surface:#0f1116;
      --surface2:#16181d;
      --ink:#e9e9ea;
      --muted:#bcbec2ee;
      --line:rgba(255,255,255,.14);
      --line2:rgba(255,255,255,.08);
      --accent:#e06a6a;
      --pos:#123019;
      --neg:#2b1214;
    }
    [data-theme="black"]{
      --bg:#050507;
      --surface:#0a0b10;
      --surface2:#07080c;
      --ink:#ececed;
      --muted:#b4b7c0;
      --line:rgba(255,255,255,.16);
      --line2:rgba(255,255,255,.08);
      --accent:#ff7a66;
      --pos:#11261a;
      --neg:#251114;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:var(--sans);
      font-size:var(--font);
      letter-spacing:.1px;
    }
    button,input,select,textarea{font:inherit;color:inherit}
    a{color:inherit}
    .mono{font-family:var(--mono)}
    .muted{color:var(--muted)}
    .thin{font-weight:800;letter-spacing:1.6px;text-transform:uppercase;font-size:11px;color:rgba(233,233,234,.9)}
    .cap{letter-spacing:2px;text-transform:uppercase;font-weight:900;font-size:12px}
    .dot{width:9px;height:9px;border:1px solid rgba(255,255,255,.22);background:#222;display:inline-block}
    .dot.ok{background:var(--ok);border-color:var(--ok)}
    .dot.bad{background:var(--bad);border-color:var(--bad)}
    .dot.warn{background:var(--warn);border-color:var(--warn)}

    .btn{
      border:1px solid var(--line);
      background:transparent;
      padding:9px 11px;
      border-radius:var(--edge);
      cursor:pointer;
      font-weight:900;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:hover{border-color:rgba(255,255,255,.24)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn.primary{
      border-color:color-mix(in oklab,var(--accent),transparent 35%);
      background:color-mix(in oklab,var(--accent),transparent 88%);
    }
    .btn.danger{
      border-color:rgba(255,95,104,.75);
      background:rgba(255,95,104,.09);
    }
    .btn.small{padding:7px 9px;font-weight:900;font-size:13px}
    .btn.tiny{padding:6px 8px;font-weight:900;font-size:12px}
    .btn.redish{
      border-color:color-mix(in oklab,var(--accent),transparent 20%);
      background:color-mix(in oklab,var(--accent),transparent 92%);
    }
    .btn.icon{
      padding:6px;
      width:30px;
      height:30px;
      font-size:13px;
    }
    .btn.icon i{font-size:14px}
    .btn.icon.chev i{transition:transform .18s ease;}
    .btn.icon.chev.collapsed i{transform:rotate(-90deg);}

    .field{
      width:100%;
      background:rgba(0,0,0,.22);
      border:1px solid var(--line);
      border-radius:var(--edge);
      padding:9px 11px;
      outline:none;
    }
    .field:focus{border-color:color-mix(in oklab, var(--accent), white 10%);box-shadow:var(--focus)}
    textarea.field{resize:vertical;min-height:170px;line-height:1.35;font-size:18px}
    .field.pos{background:color-mix(in oklab, var(--pos), black 32%);border-color:color-mix(in oklab, var(--pos), white 12%)}
    .field.neg{background:color-mix(in oklab, var(--neg), black 32%);border-color:color-mix(in oklab, var(--neg), white 12%)}
    .promptMeta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .tokenCount{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      color:var(--muted);
      font-family:var(--mono);
      letter-spacing:.2px;
    }
    .tokenCount.warn{color:color-mix(in oklab, var(--warn), var(--muted) 40%)}
    .tokenWarn{
      display:none;
      width:14px;
      height:14px;
      border-radius:999px;
      border:1px solid color-mix(in oklab, var(--warn), transparent 35%);
      color:color-mix(in oklab, var(--warn), white 8%);
      font-size:10px;
      font-weight:900;
      align-items:center;
      justify-content:center;
      opacity:.75;
    }
    .tokenWarn.show{display:inline-flex}
    .tagSuggest{
      position:fixed;
      z-index:9999;
      background:var(--surface);
      border:1px solid var(--line);
      border-radius:var(--edge);
      box-shadow:0 14px 32px rgba(0,0,0,.38);
      padding:6px;
      max-height:260px;
      overflow:auto;
      min-width:220px;
    }
    .tagSuggest.hidden{display:none}
    .tagSuggest .item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 8px;
      border-radius:8px;
      cursor:pointer;
      border:1px solid transparent;
      font-family:var(--mono);
      font-size:14px;
    }
    .tagSuggest .item.active{
      background:color-mix(in oklab, var(--accent), transparent 82%);
      border-color:color-mix(in oklab, var(--accent), transparent 55%);
    }
    .tagSuggest .item:hover{
      background:color-mix(in oklab, var(--accent), transparent 88%);
    }
    .tagSuggest .meta{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-size:12px;
    }
    .tagSuggest .empty{
      padding:8px 10px;
      color:var(--muted);
      font-size:13px;
      font-family:var(--mono);
    }
    .tagBadge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line2);
      flex-shrink:0;
      font-size:11px;
      font-weight:800;
      letter-spacing:.2px;
      color:var(--ink);
      text-transform:none;
      white-space:nowrap;
    }
    .tagBadge.cat0{background:color-mix(in oklab, #58a6ff, var(--surface2) 70%)}
    .tagBadge.cat1{background:color-mix(in oklab, #f6c56f, var(--surface2) 70%)}
    .tagBadge.cat2{background:color-mix(in oklab, #8b919b, var(--surface2) 70%)}
    .tagBadge.cat3{background:color-mix(in oklab, #ff7a6b, var(--surface2) 70%)}
    .tagBadge.cat4{background:color-mix(in oklab, #7fd47a, var(--surface2) 70%)}
    .tagBadge.cat5{background:color-mix(in oklab, #c29bff, var(--surface2) 70%)}
    .tagInfoBtn{
      border:1px solid var(--line2);
      background:transparent;
      color:var(--muted);
      width:22px;
      height:22px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .tagInfoBtn:hover{
      color:var(--ink);
      border-color:var(--line);
      background:rgba(255,255,255,.04);
    }
    .tagInfoPopup{
      position:fixed;
      z-index:10000;
      background:var(--surface);
      border:1px solid var(--line);
      border-radius:10px;
      box-shadow:0 16px 36px rgba(0,0,0,.45);
      padding:10px;
      max-width:320px;
      display:none;
    }
    .tagInfoPopup.on{display:block}
    .tagInfoHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .tagInfoLink{
      flex:1;
      min-width:0;
      font-weight:800;
      font-size:14px;
      color:var(--ink);
      text-decoration:none;
      overflow-wrap:anywhere;
    }
    .tagInfoLink:hover{text-decoration:underline}
    .tagInfoMeta{
      display:flex;
      align-items:center;
      gap:6px;
      padding-right:2px;
      flex-shrink:0;
    }
    .tagInfoCorner{
      font-size:9px;
      text-transform:uppercase;
      letter-spacing:.08em;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid color-mix(in oklab, var(--line), var(--surface) 35%);
      color:var(--ink);
      opacity:.7;
      pointer-events:none;
      background:color-mix(in oklab, var(--surface), var(--surface2) 55%);
    }
    .tagInfoCorner.cat0{background:color-mix(in oklab, #58a6ff, var(--surface) 88%)}
    .tagInfoCorner.cat1{background:color-mix(in oklab, #f6c56f, var(--surface) 88%)}
    .tagInfoCorner.cat2{background:color-mix(in oklab, #8b919b, var(--surface) 88%)}
    .tagInfoCorner.cat3{background:color-mix(in oklab, #ff7a6b, var(--surface) 88%)}
    .tagInfoCorner.cat4{background:color-mix(in oklab, #7fd47a, var(--surface) 88%)}
    .tagInfoCorner.cat5{background:color-mix(in oklab, #c29bff, var(--surface) 88%)}
    .tagInfoClose{
      border:1px solid var(--line2);
      background:transparent;
      color:var(--muted);
      width:24px;
      height:24px;
      border-radius:6px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .tagInfoClose:hover{
      color:var(--ink);
      border-color:var(--line);
      background:rgba(255,255,255,.04);
    }
    .tagInfoBody{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      max-height:200px;
      overflow:auto;
      white-space:normal;
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    .tagInfoSection + .tagInfoSection{margin-top:8px}
    .tagInfoSectionTitle{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--ink);
      margin:6px 0 4px;
    }
    .tagInfoSectionTitle.h6{
      font-size:10px;
      letter-spacing:.08em;
      color:var(--muted);
    }
    .tagInfoSection p{margin:0 0 6px}
    .tagInfoSection ul{margin:0 0 6px 18px;padding:0}
    .tagInfoSection li{margin:0 0 4px}
    .tagInfoBody strong{color:var(--ink);font-weight:700}
    .tagInfoBody a{color:var(--accent);text-decoration:none}
    .tagInfoBody a:hover{text-decoration:underline}
    .tagWikiTag{color:var(--accent);font-weight:700}

    .select{
      appearance:none;
      background-image:linear-gradient(45deg,transparent 50%,rgba(233,233,234,.65) 50%),linear-gradient(135deg,rgba(233,233,234,.65) 50%,transparent 50%);
      background-position:calc(100% - 14px) 55%,calc(100% - 9px) 55%;
      background-size:5px 5px,5px 5px;
      background-repeat:no-repeat;
      padding-right:28px
    }

    .stack{display:grid;gap:10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row.tight{gap:8px}
    .row > .grow{flex:1 1 auto}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .grid4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
    @media (max-width: 980px){
      .grid2,.grid3,.grid4{grid-template-columns:1fr}
    }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .app::before{
      content:"";
      position:fixed;
      top:var(--bar);
      bottom:var(--bar);
      left:0;
      right:0;
      border-left:1px solid var(--line2);
      border-right:1px solid var(--line2);
      pointer-events:none;
      z-index:25;
    }

    .statusbar{
      position:sticky;
      top:0;
      z-index:30;
      height:var(--bar);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 calc(var(--pad) + 4px);
      border-bottom:none;
      background:var(--framebar-bg);
      backdrop-filter:saturate(140%) blur(6px);
      min-height:var(--bar);
      gap:16px;
    }
    .statusbar::before{
      content:"";
      position:absolute;
      inset:0;
      border-left:1px solid var(--line2);
      border-right:1px solid var(--line2);
      pointer-events:none;
    }
    .brandline{
      display:flex;
      align-items:center;
      gap:16px;
      min-width:0;
    }
    .statusStack{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .brandline .name{
      font-weight:950;
      letter-spacing:4px;
      text-transform:uppercase;
      font-family:var(--brand);
      font-size:20px;
      line-height:1;
      white-space:nowrap;
      color:rgba(233,233,234,.98);
    }
    .brandline .name::after{
      content:"";
      display:inline-block;
      width:10px;
      height:10px;
      margin-left:10px;
      border:1px solid var(--line2);
      background:rgba(255,255,255,.04);
      vertical-align:middle;
      opacity:.9;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:5px 9px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:var(--edge);
      font-size:12px;
      color:rgba(233,233,234,.92);
      white-space:nowrap;
    }
    .pill .mono{font-size:12px}
    .statusgroup{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      flex-wrap:wrap;
      justify-content:flex-end;
      height:100%;
      padding-left:12px;
      border-left:1px solid var(--line2);
    }
    .statusgroup::before{
      content:"";
      width:1px;
      height:24px;
      background:var(--line2);
      align-self:center;
      margin-right:2px;
      display:none;
    }
    .statusgroup .topbarBtn{
      align-self:center;
      height:42px;
      min-width:42px;
      width:auto;
      padding:0 14px;
      border-radius:10px;
      border-color:var(--line2);
      background:rgba(255,255,255,.04);
    }
    .statusgroup .topbarBtn.active{
      border-color:color-mix(in oklab, var(--accent), transparent 40%);
      background:color-mix(in oklab, var(--accent), transparent 90%);
    }
    .statuslabel{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-size:11.5px;
      min-width:0;
    }
    .statuslabel .mono{
      max-width:24ch;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .vramWidget{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 7px;
      border:1px solid var(--line2);
      background:rgba(255,255,255,.025);
      min-width:min(170px, 58vw);
      max-width:240px;
    }
    .vramWidget .icon{
      width:22px;height:22px;
      border:1px solid var(--line2);
      display:flex;align-items:center;justify-content:center;
      background:rgba(255,255,255,.02);
      flex:0 0 auto;
      font-size:11px;
    }
    .vramWidget .meta{
      display:grid;
      gap:2px;
      min-width:0;
      flex:1 1 auto;
    }
    .vramWidget .top{
      display:flex;
      align-items:baseline;
      justify-content:flex-start;
      gap:10px;
      min-width:0;
    }
    .vramWidget .top .label{
      font-size:10px;
      letter-spacing:1.6px;
      text-transform:uppercase;
      color:var(--muted);
      font-weight:900;
      white-space:nowrap;
    }
    .vramWidget .bar{
      height:8px;
      border:1px solid var(--line2);
      background:rgba(255,255,255,.02);
      position:relative;
      overflow:hidden;
    }
    .vramWidget .fill{
      position:absolute;
      left:0;top:0;bottom:0;
      width:0%;
      background:var(--vram-fill);
    }
    .vramWidget .fill.hot{
      background:var(--vram-fill-hot);
    }
    .vramWidget .ticks{
      position:absolute; inset:0;
      background:
        linear-gradient(to right, rgba(255,255,255,.08) 1px, transparent 1px);
      background-size:10% 100%;
      opacity:.55;
      pointer-events:none;
      mix-blend-mode:screen;
    }
    .vramWidget .note{
      font-size:10px;
      color:var(--muted);
      font-family:var(--mono);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .vramWidget .note.vramok{color:color-mix(in oklab, var(--ok), var(--muted) 55%)}
    .vramWidget .note.vramwarn{color:color-mix(in oklab, var(--warn), var(--muted) 45%)}
    .vramWidget .note.vrambad{color:color-mix(in oklab, var(--bad), var(--muted) 40%)}

    .main{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      gap:0;
      padding:var(--pad);
      padding-bottom: calc(var(--pad) + var(--foot));
    }

    .panel{
      min-height:0;
      border:1px solid var(--line);
      background:var(--surface2);
      display:flex;
      flex-direction:column;
    }

    .panelHeader{
      padding:10px var(--pad);
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex:0 0 auto;
    }

    .panelBody{
      padding:var(--pad);
      overflow:auto;
      min-height:0;
      -webkit-overflow-scrolling:touch;
      scroll-behavior:smooth;
    }

    .divider{
      width:10px;
      cursor:col-resize;
      flex:0 0 auto;
      position:relative;
    }
    .divider::before{
      content:"";
      position:absolute;
      top:0;bottom:0;
      left:50%;
      width:1px;
      transform:translateX(-50%);
      background:var(--line2);
    }
    .divider::after{
      content:"";
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      width:6px;height:38px;
      border:1px solid var(--line2);
      background:rgba(255,255,255,.02);
    }

    .section{
      border:1px solid var(--line);
      background:var(--surface);
    }
    .sectionTitle{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sectionBody{padding:10px}

    .toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      border-top:1px solid var(--line);
      padding-top:10px;
      margin-top:10px;
    }
    .toolbarLeft,.toolbarRight{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .presetToolbar{
      flex-wrap:wrap;
      justify-content:flex-start;
      overflow-x:visible;
    }
    .presetToolbar .toolbarLeft,
    .presetToolbar .toolbarRight{
      flex-wrap:nowrap;
      align-items:center;
    }
    .presetToolbar .toolbarRight{margin-left:auto}
    .presetToolbar .toolbarLeft{flex:1 1 100%;}
        .presetSelect{
      width:100%;
      flex:1 1 260px;
      padding:6px 28px 6px 10px;
      font-size:13px;
      height:30px;
    }

    .aspectWrap{
      display:grid;
      grid-template-columns: minmax(260px, 340px) 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .aspectWrap{grid-template-columns:1fr}
    }
    .sketchBox{
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      padding:12px;
      display:grid;
      gap:10px;
      align-content:start;
    }

    /* New: integrated aspect picker widget */
    .frameWidget{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.12));
      padding:12px;
      display:grid;
      gap:12px;
      container-type:inline-size;
    }
    .frameHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .hint{
      width:26px;height:26px;
      border:1px solid var(--line2);
      background:rgba(255,255,255,.02);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:help;
      color:var(--muted);
      flex:0 0 auto;
    }
    .frameBody{
      display:grid;
      grid-template-columns: minmax(220px, 320px) 1fr;
      gap:12px;
      align-items:start;
    }
    @container (max-width: 520px){
      .frameBody{grid-template-columns:1fr}
    }
    .frameSketch{display:flex;align-items:stretch;justify-content:flex-start;width:100%}
    .frameSketchInner{
      display:flex;
      align-items:stretch;
      justify-content:flex-start;
      width:100%;
      max-width:320px;
      aspect-ratio:1/1;
      border:1px solid var(--line2);
      background:rgba(0,0,0,.22);
      padding:6px;
    }
    .frameSketchInner .sketchCanvas{
      width:100%;
      height:100%;
      border:none;
      display:block;
    }
    .frameInfo{
      border:1px solid var(--line2);
      background:rgba(255,255,255,.02);
      padding:12px;
      display:grid;
      gap:10px;
      align-content:start;
      height:var(--frameInfoH, auto);
      overflow:auto;
    }
    .frameCustom{
      display:grid;
      gap:8px;
    }
    .frameCustom.is-disabled{opacity:.6}
    .frameLine{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--line2);
      padding:6px 0;
    }
    .frameLine:last-child{border-bottom:none}
    .frameLine .k{color:var(--muted);font-size:12px}
    .frameLine .v{font-family:var(--mono);font-size:13px;color:rgba(233,233,234,.95);text-align:right;white-space:nowrap}
    .mpWarn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-left:10px;
      color:color-mix(in oklab, var(--warn), var(--muted) 35%);
      font-size:11px;
      opacity:.95;
    }
    .mpControls{display:none;gap:8px;align-items:center;margin-top:8px}
    .mpControls.on{display:grid}
    .mpRange{width:100%}
    .mpToggle{width:30px;height:30px}
    .mpToggle i{transition:transform .18s ease}
    .mpToggle.collapsed i{transform:rotate(-90deg)}
    .mpMeta{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .seedRow{
      display:flex;
      gap:8px;
      width:100%;
      align-items:center;
    }
    .seedRow .field{
      flex:1 1 auto;
      min-width:0;
    }

    .sketchHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .helpIcon{
      width:26px;height:26px;
      border:1px solid var(--line2);
      background:rgba(255,255,255,.02);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:help;
      color:var(--muted);
      flex:0 0 auto;
    }
    .sketchCanvas{
      width:240px;
      height:240px;
      border:1px solid var(--line);
      background:#07080b;
      touch-action:none;
      image-rendering:pixelated;
      justify-self:start;
    }
    @media (max-width: 740px){
      .sketchCanvas{width:220px;height:220px}
    }
    .sketchMeta{
      display:grid;
      gap:8px;
    }
    .metaRow{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      border-top:1px solid var(--line2);
      padding-top:8px;
    }
    .metaRow:first-child{border-top:none;padding-top:0}
    .metaRow .k{color:var(--muted);font-size:12px}
    .metaRow .v{font-family:var(--mono);font-size:13px;color:rgba(233,233,234,.95);text-align:right;white-space:nowrap}
    .metaRow .v.tight{font-size:12px}
    .mpWarnSubtle{
      display:flex;
      align-items:center;
      gap:8px;
      color:color-mix(in oklab, var(--warn), var(--muted) 45%);
      font-size:11px;
      line-height:1.2;
    }
    .mpWarnSubtle i{opacity:.9}
    .aspectReadout{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      padding:10px;
      display:grid;
      gap:10px;
    }
    .readoutLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--line2);
      padding-bottom:8px;
    }
    .readoutLine:last-child{border-bottom:none;padding-bottom:0}
    .readoutLine .k{color:var(--muted);font-size:12px}
    .readoutLine .v{font-family:var(--mono);font-size:13px;color:rgba(233,233,234,.95);text-align:right}
    .finalSizeLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
    }
    .finalSizeLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .finalSizeText{
      display:grid;
      gap:2px;
    }
    .finalSizeText .big{
      font-family:var(--mono);
      font-size:15px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .finalSizeText .sub{
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .warnIcon{
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:var(--warn);
      cursor:help;
    }

    .collapseBtn{
      border:1px solid var(--line2);
      background:rgba(255,255,255,.02);
      width:30px;
      height:30px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:var(--muted);
      border-radius:var(--edge);
      flex:0 0 auto;
    }
    .collapseBtn:hover{border-color:color-mix(in oklab, var(--line), white 8%);color:rgba(233,233,234,.92)}
    .section[data-collapsed="1"] .sectionBody{display:none}
    .section[data-collapsed="1"] .collapseBtn i{transform:rotate(-90deg)}

    details{
      border:1px solid var(--line);
      background:rgba(0,0,0,.16);
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
      border-bottom:1px solid var(--line);
    }
    details[open] summary{border-bottom:1px solid var(--line)}
    summary::-webkit-details-marker{display:none}
    .detailsBody{padding:10px}

    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));
      gap:12px;
      align-content:start;
    }
    .card{
      border:1px solid var(--line);
      background:var(--surface);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .card img{
      width:100%;
      display:block;
      background:#06070a;
    }
    .cardMeta{
      border-top:1px solid var(--line);
      padding:10px;
      display:grid;
      gap:8px;
      min-height:0;
    }
    .cardTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cardStage{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
      flex-wrap:wrap;
    }
    .cardActions{
      display:flex;
      gap:6px;
      flex:0 0 auto;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .promptFold{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
    }
    .promptFold summary{
      padding:8px 10px;
      border-bottom:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
    }
    .promptFold .detailsBody{
      padding:8px 10px;
      font-family:var(--mono);
      font-size:12px;
      white-space:pre-wrap;
      word-break:break-word;
      max-height:160px;
      overflow:auto;
      color:rgba(233,233,234,.92);
    }

    .drawer{
      position:fixed;
      top:var(--bar);
      right:0;
      width:min(460px, 92vw);
      height:calc(100vh - var(--bar));
      background:rgba(12,14,18,.96);
      border-left:1px solid var(--line);
      display:none;
      flex-direction:column;
      z-index:60;
    }
    .drawer.on{display:flex}
    .drawerHead{
      padding:10px var(--pad);
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex:0 0 auto;
    }
    .drawerBody{
      padding:var(--pad);
      overflow:auto;
      min-height:0;
      display:grid;
      gap:12px;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom: calc(16px + var(--foot));
      transform:translateX(-50%);
      background:rgba(0,0,0,.86);
      border:1px solid var(--line);
      padding:8px 12px;
      font-size:12px;
      color:rgba(233,233,234,.92);
      display:none;
      z-index:80;
    }
    .toast.on{display:block}

    .footerbar{
      position:fixed;
      left:0;right:0;bottom:0;
      height:var(--foot);
      border-top:none;
      background:var(--framebar-bg);
      backdrop-filter:saturate(140%) blur(6px);
      z-index:40;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
    }
    .footerbar::before{
      content:"";
      position:absolute;
      inset:0;
      border-left:1px solid var(--line2);
      border-right:1px solid var(--line2);
      pointer-events:none;
    }
    .footerInner{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:8px calc(var(--pad) + 4px);
      border:1px solid var(--line2);
      background:rgba(255,255,255,.025);
    }
    .footerLeft,.footerRight{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .footerLeft{justify-self:start}
    .footerRight{justify-self:end}
    .btn.big{height:42px;padding:0 16px;font-size:14px;letter-spacing:.3px;border-radius:10px}
    .btn.big i{opacity:.95}
    .footerMeta{
      display:inline-flex;
      gap:10px;
      align-items:center;
      color:var(--muted);
      font-size:11.5px;
      padding:6px 10px;
      border:1px solid var(--line2);
      background:rgba(0,0,0,.24);
    }
    .footerbar .btn{
      border-color:var(--line2);
      background:rgba(255,255,255,.04);
    }
    #purgeVramBtn{
      border-color:color-mix(in oklab, var(--cache-btn), transparent 40%);
      background:color-mix(in oklab, var(--cache-btn), transparent 70%);
      color:color-mix(in oklab, var(--cache-btn), var(--ink) 35%);
    }
    #purgeVramBtn.cache-clear{
      border-color:color-mix(in oklab, var(--cache-btn-ok), transparent 40%);
      background:color-mix(in oklab, var(--cache-btn-ok), transparent 70%);
      color:color-mix(in oklab, var(--cache-btn-ok), var(--ink) 40%);
    }

    @media (max-width: 900px){
      .brandline .name{letter-spacing:2.6px;font-size:18px}
      .statusgroup::before{display:none}
    }
    @media (max-width: 740px){
      .main{padding:10px;padding-bottom: calc(10px + var(--foot))}
      .footerInner{flex-direction:column;justify-content:center;align-items:stretch}
      .footerLeft,.footerRight{justify-content:center}
      .footerMeta{justify-content:center}
      .cards{grid-template-columns:1fr}
      .vramWidget{min-width:0;width:100%;max-width:none}
      textarea.field{font-size:18px;min-height:190px}
    }
  </style>
</head>

<body>
<div class="app" id="appRoot">

  <div class="statusbar">
    <div class="brandline">
      <div class="name">BUMFY</div>

      <div class="statusStack">
        <div class="statuslabel" title="Backend">
          <span class="dot" id="backendDot"></span>
          <span id="backendText">disconnected</span>
          <span class="mono" id="backendDetail"></span>
        </div>

        <div class="statuslabel" title="Run">
          <span class="dot" id="runDot"></span>
          <span id="runText">idle</span>
          <span class="mono" id="runDetail"></span>
        </div>
      </div>
    </div>

    <div class="statusgroup">
      <div class="vramWidget" title="VRAM usage">
        <div class="icon" aria-hidden="true"><i class="fa-solid fa-memory"></i></div>
        <div class="meta">
          <div class="top">
            <div class="label">VRAM Usage</div>
          </div>
          <div class="bar" aria-hidden="true">
            <div class="fill" id="vramFill"></div>
            <div class="ticks"></div>
          </div>
          <div class="note" id="vramNote">--</div>
        </div>
      </div>

      <button class="btn icon topbarBtn" type="button" id="purgeVramBtn" title="Unload models / free VRAM" aria-label="Unload models">
        <i class="fa-solid fa-broom"></i>
      </button>

      <button class="btn small topbarBtn" type="button" id="openSettings" title="Settings" aria-expanded="false">
        <i class="fa-solid fa-gear"></i>
      </button>
    </div>
  </div>

  <div class="main" id="mainSplit">
    <div class="panel" id="createPanel" style="width: 520px; min-width: 360px; max-width: 760px;">
      <div class="panelHeader">
        <div class="row tight" style="min-width:0;gap:12px">
          <div class="thin" style="letter-spacing:.2px;white-space:nowrap">Generation</div>
        </div>
        <div class="row tight" style="justify-content:flex-end">
          <span class="muted" style="font-size:12px" id="headerHint"></span>
        </div>
      </div>

      <div class="panelBody">
        <div class="stack">

          <div class="section">
            <div class="sectionTitle">
              <div class="thin">Prompts</div>
              <div class="row tight" style="justify-content:flex-end">
                <span class="muted" style="font-size:12px;white-space:nowrap;max-width:30ch;overflow:hidden;text-overflow:ellipsis" title="Applied quality tags" id="tagsBadge">none</span>
              </div>
            </div>

            <div class="sectionBody stack">
              <div class="stack">
                <div class="promptMeta">
                  <div class="muted" style="font-size:12px">Positive</div>
                  <div class="tokenCount" data-for="positivePrompt">
                    <span class="tokenText">0</span>
                    <span class="tokenWarn" title="Prompts above 75 may lose prompt adherence and image quality.">!</span>
                  </div>
                </div>
                <textarea class="field pos" id="positivePrompt" placeholder="masterpiece, best quality, amazing quality, 1girl, smile, happy, :D, waving, rating:general "></textarea>
              </div>

              <div class="stack">
                <div class="promptMeta">
                  <div class="muted" style="font-size:12px">Negative</div>
                  <div class="tokenCount" data-for="negativePrompt">
                    <span class="tokenText">0</span>
                    <span class="tokenWarn" title="Prompts above 75 may lose prompt adherence and image quality.">!</span>
                  </div>
                </div>
                <textarea class="field neg" id="negativePrompt" placeholder="worst quality, low quality, signature, username, logo"></textarea>
              </div>

              <div id="secondPromptBlock" class="stack" style="display:none">
                <div class="row" style="justify-content:space-between;align-items:center">
                  <div class="thin">Second pass prompts</div>
                  <span class="muted" style="font-size:12px">Only used when enabled</span>
                </div>

                <div class="stack">
                  <div class="promptMeta">
                    <div class="muted" style="font-size:12px">Positive (2nd)</div>
                    <div class="tokenCount" data-for="positivePrompt2">
                      <span class="tokenText">0</span>
                      <span class="tokenWarn" title="Prompts above 75 may lose prompt adherence and image quality.">!</span>
                    </div>
                  </div>
                  <textarea class="field pos" id="positivePrompt2" placeholder="Optional second pass positive..."></textarea>
                </div>

                <div class="stack">
                  <div class="promptMeta">
                    <div class="muted" style="font-size:12px">Negative (2nd)</div>
                    <div class="tokenCount" data-for="negativePrompt2">
                      <span class="tokenText">0</span>
                      <span class="tokenWarn" title="Prompts above 75 may lose prompt adherence and image quality.">!</span>
                    </div>
                  </div>
                  <textarea class="field neg" id="negativePrompt2" placeholder="Optional second pass negative..."></textarea>
                </div>
              </div>

              <div class="toolbar presetToolbar">
                <div class="toolbarLeft">
                  <select class="field select mono presetSelect" id="qualityPresetSelect"></select>
                  <button class="btn icon" type="button" id="loadQualityPresetBtn" title="Load preset" aria-label="Load preset"><i class="fa-solid fa-folder-open"></i></button>
                  <button class="btn icon" type="button" id="saveQualityPresetBtn" title="Save preset" aria-label="Save preset"><i class="fa-solid fa-floppy-disk"></i></button>
                </div>
                <div class="toolbarRight">
                  <button class="btn icon" type="button" id="clearQualityPresetBtn" title="Clear applied tags" aria-label="Clear applied tags"><i class="fa-solid fa-eraser"></i></button>
                </div>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <div class="thin">Size</div>
              <div class="row tight" style="justify-content:flex-end;gap:8px">
                <span class="pill" title="Resolution"><span class="mono" id="sizeSectionBadge">—</span></span>
                <button class="btn icon chev" type="button" id="toggleSizeSection" title="Collapse/expand">
                  <i class="fa-solid fa-chevron-down"></i>
                </button>
              </div>
            </div>

            <div class="sectionBody stack" id="sizeSectionBody">

              <div class="frameWidget">
                <div class="frameHead">
                  <div class="row tight" style="gap:10px;min-width:0">
                    <div class="thin" id="aspectPickerTitle">Frame Tool</div>
                    <button class="hint" type="button" title="Click + drag to set the image shape.">
                      <i class="fa-regular fa-circle-question"></i>
                    </button>
                  </div>
                  <button class="btn icon" type="button" id="resetSketch" title="Reset sketch" aria-label="Reset sketch">
                    <i class="fa-solid fa-rotate-left"></i>
                  </button>
                </div>

                <div class="frameBody">
                  <div class="frameSketch">
                    <div class="frameSketchInner">
                      <canvas class="sketchCanvas big" id="aspectCanvas" width="220" height="220"></canvas>
                    </div>
                  </div>

                  <div class="frameInfo" id="frameInfo">
                    <div class="frameLine">
                      <div class="k">Final</div>
                      <div class="v">
                        <span class="mono" id="finalSizeText">--</span>
                        <span class="muted" id="finalMpText" style="margin-left:10px">--</span>
                      </div>
                    </div>

                    <div class="frameLine">
                      <div class="k">Base</div>
                      <div class="v"><span class="mono" id="baseSizeText">--</span></div>
                    </div>

                    <div class="frameLine">
                      <div class="k">Aspect</div>
                      <div class="v"><span class="mono" id="finalAspectText">--</span></div>
                    </div>

                    <div class="frameLine">
                      <div class="k">Custom size</div>
                      <div class="v">
                        <label class="row tight" style="margin:0;color:var(--muted);font-size:12px">
                          <input type="checkbox" id="customSizeEnabled" />
                          <span>Enable</span>
                        </label>
                      </div>
                    </div>
                    <div class="frameCustom" id="customSizeFields">
                      <div class="grid2">
                        <div class="stack">
                          <div class="muted" style="font-size:12px">Width</div>
                          <input class="field mono" id="customWidth" type="number" min="64" step="8" value="832" />
                        </div>
                        <div class="stack">
                          <div class="muted" style="font-size:12px">Height</div>
                          <input class="field mono" id="customHeight" type="number" min="64" step="8" value="1216" />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>

              <div class="section" style="border:none;background:transparent">
                <div class="grid3 seedBatchGrid">
                  <div class="stack">
                    <div class="muted" style="font-size:12px">Seed mode</div>
                    <select class="field select mono" id="seedMode">
                      <option value="random">random</option>
                      <option value="fixed">fixed</option>
                      <option value="increment">increment</option>
                    </select>
                  </div>

                  <div class="stack">
                    <div class="muted" style="font-size:12px">Seed</div>
                    <div class="seedRow">
                      <input class="field mono" id="seedValue" type="number" step="1" value="791" />
                      <button class="btn small" type="button" id="randomizeSeedBtn" title="Randomize seed"><i class="fa-solid fa-dice"></i></button>
                    </div>
                  </div>

                  <div class="stack">
                    <div class="muted" style="font-size:12px">Batch</div>
                    <input class="field mono" id="batchSize" type="number" min="1" max="16" step="1" value="1" />
                  </div>
                </div>
              </div>

              <details id="refineInlineDetails" class="subDetails">
                <summary>
                  <span class="thin">Refine</span>
                  <span class="muted mono" id="refineBadge">off</span>
                </summary>
                <div class="detailsBody stack">
                  <div class="row" style="justify-content:space-between">
                    <label class="row tight" style="margin:0;color:var(--muted);font-size:12px">
                      <input type="checkbox" id="enableSecondPass" />
                      <span>Enable second pass</span>
                    </label>

                    <label class="row tight" style="margin:0;color:var(--muted);font-size:12px">
                      <input type="checkbox" id="editSecondPrompts" />
                      <span>Edit second prompts</span>
                    </label>
                  </div>

                  <div class="row" style="justify-content:space-between">
                    <label class="row tight" style="margin:0;color:var(--muted);font-size:12px">
                      <input type="checkbox" id="enableUpscale" checked />
                      <span>Upscale before pass</span>
                    </label>

                    <span class="muted mono" id="scaleBadge" title="Conceptual scale">1.50x—</span>
                  </div>

                  <input type="range" id="conceptScale" min="1.00" max="2.00" step="0.01" value="1.50" />
                </div>
              </details>

            </div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <div class="thin">Model Settings</div>
              <div class="row tight" style="justify-content:flex-end">
                <span class="pill" title="Sampler / Scheduler"><span class="mono" id="samplerSchedulerBadge">—</span></span>
                <button class="btn icon chev" type="button" id="toggleModelSettings" title="Collapse/expand">
                  <i class="fa-solid fa-chevron-down"></i>
                </button>
              </div>
            </div>

            <div class="sectionBody stack" id="modelSettingsBody">
              <div class="grid4">
                <div class="stack">
                  <div class="muted" style="font-size:12px">Steps</div>
                  <input class="field mono" id="steps1" type="number" min="1" max="200" step="1" value="24" />
                </div>

                <div class="stack">
                  <div class="muted" style="font-size:12px">CFG</div>
                  <input class="field mono" id="cfg1" type="number" min="0" max="30" step="0.1" value="6" />
                </div>

                <div class="stack">
                  <div class="muted" style="font-size:12px">Sampler</div>
                  <select class="field select mono" id="samplerName"></select>
                </div>

                <div class="stack">
                  <div class="muted" style="font-size:12px">Scheduler</div>
                  <select class="field select mono" id="schedulerName"></select>
                </div>
              </div>

              <div class="stack">
                <div class="muted" style="font-size:12px">Checkpoint</div>
                <select class="field select mono" id="checkpointName"></select>
              </div>

              <div id="secondPassSettings" class="stack" style="display:none">
                <div class="row" style="justify-content:space-between;align-items:center">
                  <div class="thin">Second pass</div>
                  <div class="muted" style="font-size:12px">When enabled</div>
                </div>

                <div class="grid3">
                  <div class="stack">
                    <div class="muted" style="font-size:12px">Steps (2nd)</div>
                    <input class="field mono" id="steps2" type="number" min="1" max="200" step="1" value="18" />
                  </div>
                  <div class="stack">
                    <div class="muted" style="font-size:12px">CFG (2nd)</div>
                    <input class="field mono" id="cfg2" type="number" min="0" max="30" step="0.1" value="6" />
                  </div>
                  <div class="stack">
                    <div class="muted" style="font-size:12px">Denoise (2nd)</div>
                    <input class="field mono" id="denoise2" type="number" min="0.01" max="1.00" step="0.01" value="0.52" />
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="divider" id="splitHandle" aria-label="Resize panels"></div>

    <div class="panel" id="outputPanel" style="flex:1 1 auto; min-width: 340px;">      
      <div class="panelHeader">
        <div class="row tight" style="min-width:0;gap:12px">
          <div class="thin" style="letter-spacing:.2px;white-space:nowrap">Output</div>
        </div>
      </div>
      <div class="panelBody">
        <div class="cards" id="galleryCards"></div>
      </div>
    </div>

  </div>

  <div class="footerbar">
    <div class="footerInner">
      <div class="footerLeft">
        <button class="btn big primary" type="button" id="generateBtn"><i class="fa-solid fa-wand-magic-sparkles"></i><span>Generate</span></button>
        <button class="btn big danger" type="button" id="stopBtn" disabled><i class="fa-solid fa-hand"></i><span>Stop</span></button>
      </div>

      <div class="footerMeta">
        <span id="queueMeta" class="mono">idle</span>
      </div>

      <div class="footerRight">
        <button class="btn big" type="button" id="clearGalleryBtn"><i class="fa-solid fa-trash"></i><span>Clear</span></button>
      </div>
    </div>
  </div>

</div>

<div class="drawer" id="settingsDrawer">
  <div class="drawerHead">
    <div class="cap">Settings</div>
  </div>
      <div class="drawerBody">

    <div class="section">
      <div class="sectionTitle"><div class="thin">Connections</div></div>
      <div class="sectionBody stack">
        <div class="stack">
          <div class="muted" style="font-size:12px">ComfyUI URL</div>
          <div class="row" style="align-items:flex-end">
            <input class="field mono" id="baseUrl" type="text" value="http://127.0.0.1:8188" style="flex:1 1 auto" />
            <button class="btn" type="button" id="connectBtn"><i class="fa-solid fa-plug"></i><span>Connect</span></button>
          </div>
          <div class="muted mono" id="baseBadge" style="font-size:12px;white-space:nowrap;max-width:42ch;overflow:hidden;text-overflow:ellipsis" title="Base URL">—</div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="sectionTitle"><div class="thin">Appearance</div></div>
      <div class="sectionBody stack">
        <div class="stack">
          <div class="muted" style="font-size:12px">Theme</div>
          <select class="field select mono" id="themeSelect">
            <option value="light">light</option>
            <option value="dark">dark</option>
            <option value="black">black</option>
          </select>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="sectionTitle"><div class="thin">Advanced Options</div></div>
      <div class="sectionBody stack">

        <details id="advPromptsDetails" open>
          <summary>
            <span class="thin">Prompts</span>
            <span class="muted mono" id="advPromptsBadge">default</span>
          </summary>
          <div class="detailsBody stack">
            <label class="row" style="align-items:center;gap:10px">
              <input type="checkbox" id="optUseTokenCounter" checked />
              <span>Use Token Counter</span>
            </label>
            <label class="row" style="align-items:center;gap:10px">
              <input type="checkbox" id="optShowTokenAlert" checked />
              <span>Show Token Usage Alert</span>
            </label>

            <div class="hr"></div>

            <label class="row" style="align-items:center;gap:10px">
              <input type="checkbox" id="optUseAutocomplete" checked />
              <span>Use Autocomplete</span>
            </label>
            <div class="stack" id="wikiFeaturesWrap" style="padding-left:22px">
              <label class="row" style="align-items:center;gap:10px">
                <input type="checkbox" id="optUseWiki" checked />
                <span>Enable Danbooru Tag Wiki Features</span>
              </label>
              <div class="stack">
                <div class="muted" style="font-size:12px">Tag Blacklist</div>
                <textarea class="field mono" id="optTagBlacklist" rows="3" placeholder="one tag per line"></textarea>
                <div class="muted" style="font-size:12px">Do not show blacklisted tags in the autocomplete list.</div>
              </div>
            </div>

            <div class="hr"></div>

            <label class="row" style="align-items:center;gap:10px">
              <input type="checkbox" id="optTrimTrailingComma" checked />
              <span>Remove Trailing Comma From Prompts</span>
            </label>
            <div class="muted" style="font-size:12px">If a generation is started and a prompt ends with a comma (or comma+space), it will be removed automatically.</div>

          </div>
        </details>

        <details id="advSizingDetails" open>
          <summary>
            <span class="thin">Sizing</span>
            <span class="muted mono" id="advSizingBadge">default</span>
          </summary>
          <div class="detailsBody stack">
            <div class="grid2">
              <div class="stack">
                <div class="muted" style="font-size:12px">MP tolerance (±)</div>
                <input class="field mono" id="mpTolerance" type="number" min="0.01" max="0.40" step="0.01" value="0.10" />
              </div>
              <div class="stack">
                <div class="row tight" style="justify-content:space-between">
                  <div class="muted" style="font-size:12px">Target MP</div>
                  <span class="mono" id="targetMpBadge">1.05</span>
                </div>
                <input class="mpRange" type="range" id="targetMp" min="0.50" max="2.00" step="0.01" value="1.05" />
                <div class="muted" style="font-size:12px;display:flex;justify-content:space-between;gap:12px">
                  <span>Allowed: 0.50–2.00</span>
                  <span id="targetMpWarn" style="opacity:.9"></span>
                </div>
              </div>
            </div>
          </div>
        </details>

      </div>
    </div>

    <div class="section">
      <div class="sectionTitle"><div class="thin">Storage</div></div>
      <div class="sectionBody stack">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="stack" style="flex:1 1 auto">
            <div class="muted" style="font-size:12px">LocalStorage used by Bumfy</div>
            <div class="mono" id="storageUsage">—</div>
          </div>
          <button class="btn danger" type="button" id="storageResetBtn"><i class="fa-solid fa-triangle-exclamation"></i><span>Reset</span></button>
        </div>
        <div class="muted" style="font-size:12px">Danger: this clears Bumfy settings, UI snapshot, and cached tag wiki data.</div>
      </div>
    </div>

    <div class="row" style="justify-content:flex-end;gap:10px;margin-top:10px">
      <button class="btn" type="button" id="settingsSaveBtn"><i class="fa-solid fa-floppy-disk"></i><span>Save</span></button>
    </div>

  </div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(function(){
"use strict";

  const $ = (id) => document.getElementById(id);
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const clamp = (n,a,b)=>Math.min(b,Math.max(a,n));
  const roundStep = (n, step)=>Math.round(n/step)*step;
  const normalizeTagKey = (value) => String(value || "").trim().toLowerCase().replace(/\s+/g, "_");
  const formatTagLabel = (value) => String(value || "").replace(/_/g, " ");
  const formatTagCount = new Intl.NumberFormat("en-US");
  const TAG_SOURCE_URL = "https://huggingface.co/datasets/newtextdoc1111/danbooru-tag-csv/resolve/main/danbooru_tags.csv?download=true";
  const TAG_SUGGEST_LIMIT = 12;
  const TAG_WIKI_BASE = "https://danbooru.donmai.us/wiki_pages/";
  const TAG_WIKI_CACHE_KEY = "bumfy_tag_wiki_cache_v1";
  const TOKEN_LIMIT = 75;
  const TOKEN_WARN_TEXT = "Prompts above 75 may lose prompt adherence and image quality.";
  const TAG_CATEGORY_LABELS = {
    0:"General",
    1:"Artist",
    2:"Unknown",
    3:"Copyright",
    4:"Character",
    5:"Meta",
  };
  const tagIndex = { loading:false, loaded:false, keys:[], error:"" };
  const tagSuggest = { el:null, field:null, items:[], active:0, tokenRange:null, visible:false };
  const tagWikiCache = { loaded:false, map:{} };
  const tagInfoPopup = { el:null, link:null, body:null, corner:null, anchor:null, open:false, tag:"" };

  function escapeHtml(value){
    return String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function normalizeTagGroupSlug(label){
    const parts = label.split(":");
    if(parts.length < 2) return "";
    const name = parts.slice(1).join(":").trim();
    return name
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, "_")
      .replace(/^_+|_+$/g, "");
  }

  function formatWikiInline(text){
    let out = "";
    let last = 0;
    let boldOpen = false;
    let italicOpen = false;
    const re = /\[\[([^\]]+)\]\]|\[b\]|\[\/b\]|\[i\]|\[\/i\]/gi;
    let match;
    while((match = re.exec(text))){
      out += escapeHtml(text.slice(last, match.index));
      if(match[1] !== undefined){
        const raw = match[1].trim();
        const parts = raw.split("|");
        const target = (parts[0] || "").trim();
        const display = (parts.slice(1).join("|").trim() || target).trim();
        if(/^tag\s*group:/i.test(target)){
          const slug = normalizeTagGroupSlug(target);
          if(slug){
            const href = `${TAG_WIKI_BASE}${encodeURIComponent(`tag_group:${slug}`)}`;
            out += `<a class="tagWikiTag" href="${href}" target="_blank" rel="noopener noreferrer">${escapeHtml(display)}</a>`;
          }else{
            out += `<span class="tagWikiTag">${escapeHtml(display)}</span>`;
          }
        }else{
          out += `<span class="tagWikiTag">${escapeHtml(display)}</span>`;
        }
      }else{
        const token = match[0].toLowerCase();
        if(token === "[b]" && !boldOpen){
          out += "<strong>";
          boldOpen = true;
        }else if(token === "[/b]" && boldOpen){
          out += "</strong>";
          boldOpen = false;
        }else if(token === "[i]" && !italicOpen){
          out += "<em>";
          italicOpen = true;
        }else if(token === "[/i]" && italicOpen){
          out += "</em>";
          italicOpen = false;
        }
      }
      last = match.index + match[0].length;
    }
    out += escapeHtml(text.slice(last));
    if(italicOpen) out += "</em>";
    if(boldOpen) out += "</strong>";
    return out;
  }

  function renderWikiLines(lines){
    const html = [];
    let paragraph = [];
    let inList = false;
    const flushParagraph = ()=>{
      if(!paragraph.length) return;
      html.push(`<p>${formatWikiInline(paragraph.join(" "))}</p>`);
      paragraph = [];
    };
    for(const line of lines){
      const trimmed = line.trim();
      if(!trimmed){
        flushParagraph();
        if(inList){
          html.push("</ul>");
          inList = false;
        }
        continue;
      }
      if(/^\*\s+/.test(trimmed)){
        flushParagraph();
        if(!inList){
          html.push("<ul>");
          inList = true;
        }
        html.push(`<li>${formatWikiInline(trimmed.replace(/^\*\s+/, ""))}</li>`);
        continue;
      }
      if(inList){
        html.push("</ul>");
        inList = false;
      }
      paragraph.push(trimmed);
    }
    flushParagraph();
    if(inList) html.push("</ul>");
    return html.join("");
  }

  function formatTagWikiBody(raw){
    const text = String(raw || "").trim();
    if(!text) return "";
    const lines = text.split(/\r?\n/);
    const sections = [];
    let current = { title:null, lines:[] };
    let skip = false;
    for(const line of lines){
      const headerMatch = /^(h4|h6)\.\s*(.+)$/i.exec(line.trim());
      if(headerMatch){
        if(current.title || current.lines.length){
          sections.push(current);
        }
        const level = headerMatch[1].toLowerCase();
        const title = headerMatch[2].trim();
        const isExamples = /^examples\b/i.test(title);
        const isExternal = /^external\s+links\b/i.test(title);
        skip = isExamples || isExternal;
        current = { title:skip ? null : title, level:skip ? null : level, lines:[] };
        continue;
      }
      if(skip) continue;
      current.lines.push(line);
    }
    if(current.title || current.lines.length){
      sections.push(current);
    }
    return sections.map((section)=>{
      const bodyHtml = renderWikiLines(section.lines);
      if(section.title){
        const titleClass = section.level === "h6" ? " tagInfoSectionTitle h6" : " tagInfoSectionTitle";
        return `<section class="tagInfoSection"><div class="${titleClass.trim()}">${escapeHtml(section.title)}</div>${bodyHtml}</section>`;
      }
      return `<section class="tagInfoSection">${bodyHtml}</section>`;
    }).join("");
  }

  function loadTagWikiCache(){
    if(tagWikiCache.loaded) return;
    tagWikiCache.loaded = true;
    try{
      const raw = localStorage.getItem(TAG_WIKI_CACHE_KEY);
      const parsed = raw ? JSON.parse(raw) : {};
      if(parsed && typeof parsed === "object") tagWikiCache.map = parsed;
    }catch(_){
      tagWikiCache.map = {};
    }
  }

  function saveTagWikiCache(){
    try{
      localStorage.setItem(TAG_WIKI_CACHE_KEY, JSON.stringify(tagWikiCache.map));
    }catch(_){}
  }

  async function fetchTagWiki(tag){
    loadTagWikiCache();
    const cached = tagWikiCache.map[tag];
    if(cached && typeof cached.body === "string") return cached;
    const url = `${TAG_WIKI_BASE}${encodeURIComponent(tag)}.json`;
    const res = await fetch(url, { cache:"force-cache" });
    if(!res.ok) throw new Error("wiki fetch failed");
    const data = await res.json();
    const entry = { body: String(data?.body || "").trim(), at: Date.now() };
    tagWikiCache.map[tag] = entry;
    saveTagWikiCache();
    return entry;
  }

  function ensureTagInfoPopup(){
    if(tagInfoPopup.el) return;
    const popup = document.createElement("div");
    popup.className = "tagInfoPopup";
    popup.setAttribute("role", "dialog");
    const header = document.createElement("div");
    header.className = "tagInfoHeader";
    const link = document.createElement("a");
    link.className = "tagInfoLink";
    link.target = "_blank";
    link.rel = "noopener noreferrer";
    const meta = document.createElement("div");
    meta.className = "tagInfoMeta";
    const corner = document.createElement("div");
    corner.className = "tagInfoCorner cat0";
    const close = document.createElement("button");
    close.className = "tagInfoClose";
    close.type = "button";
    close.innerHTML = '<i class="fa-solid fa-xmark"></i>';
    close.addEventListener("click", closeTagInfo);
    header.appendChild(link);
    meta.appendChild(corner);
    meta.appendChild(close);
    header.appendChild(meta);
    const body = document.createElement("div");
    body.className = "tagInfoBody";
    popup.appendChild(corner);
    popup.appendChild(header);
    popup.appendChild(body);
    document.body.appendChild(popup);
    tagInfoPopup.el = popup;
    tagInfoPopup.link = link;
    tagInfoPopup.body = body;
    tagInfoPopup.corner = corner;
    document.addEventListener("click", (ev)=>{
      if(!tagInfoPopup.open) return;
      if(popup.contains(ev.target)) return;
      if(ev.target.closest && ev.target.closest(".tagInfoBtn")) return;
      closeTagInfo();
    });
    window.addEventListener("resize", ()=>{ if(tagInfoPopup.open) positionTagInfoPopup(tagInfoPopup.anchor); });
    window.addEventListener("scroll", ()=>{ if(tagInfoPopup.open) positionTagInfoPopup(tagInfoPopup.anchor); }, true);
  }

  function positionTagInfoPopup(anchor){
    if(!tagInfoPopup.el || !anchor) return;
    const rect = anchor.getBoundingClientRect();
    const popup = tagInfoPopup.el;
    const popupRect = popup.getBoundingClientRect();
    let left = rect.right + 8;
    if(left + popupRect.width > window.innerWidth - 8){
      left = rect.left - popupRect.width - 8;
    }
    if(left < 8) left = 8;
    let top = rect.top - 4;
    if(top + popupRect.height > window.innerHeight - 8){
      top = window.innerHeight - popupRect.height - 8;
    }
    if(top < 8) top = 8;
    popup.style.left = `${left}px`;
    popup.style.top = `${top}px`;
  }

  async function openTagInfo(tag, anchor, category){
    if(!tag) return;
    ensureTagInfoPopup();
    tagInfoPopup.anchor = anchor;
    tagInfoPopup.tag = tag;
    tagInfoPopup.link.textContent = formatTagLabel(tag);
    tagInfoPopup.link.href = `${TAG_WIKI_BASE}${encodeURIComponent(tag)}`;
    if(tagInfoPopup.corner){
      const categoryId = Number.isFinite(category) ? category : 2;
      const label = TAG_CATEGORY_LABELS[categoryId] || "Unknown";
      tagInfoPopup.corner.textContent = label;
      tagInfoPopup.corner.className = `tagInfoCorner cat${categoryId}`;
    }
    tagInfoPopup.body.textContent = "Loading...";
    tagInfoPopup.el.classList.add("on");
    tagInfoPopup.open = true;
    positionTagInfoPopup(anchor);
    try{
      const entry = await fetchTagWiki(tag);
      if(tagInfoPopup.tag !== tag) return;
      const html = formatTagWikiBody(entry.body);
      if(html){
        tagInfoPopup.body.innerHTML = html;
      }else{
        tagInfoPopup.body.textContent = "No wiki body found.";
      }
    }catch(_){
      if(tagInfoPopup.tag !== tag) return;
      tagInfoPopup.body.textContent = "Unable to load wiki info.";
    }
    positionTagInfoPopup(anchor);
  }

  function closeTagInfo(){
    if(!tagInfoPopup.el) return;
    tagInfoPopup.el.classList.remove("on");
    tagInfoPopup.open = false;
    tagInfoPopup.tag = "";
    tagInfoPopup.anchor = null;
  }

  function parseCsvLine(line){
    const out = [];
    let cur = "";
    let inQuotes = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(ch === "\""){
        if(inQuotes && line[i+1] === "\""){
          cur += "\"";
          i++;
        }else{
          inQuotes = !inQuotes;
        }
      }else if(ch === "," && !inQuotes){
        out.push(cur);
        cur = "";
      }else{
        cur += ch;
      }
    }
    out.push(cur);
    return out;
  }

  async function loadTagIndex(){
    if(tagIndex.loaded || tagIndex.loading) return;
    tagIndex.loading = true;
    tagIndex.error = "";
    try{
      const res = await fetch(TAG_SOURCE_URL, { cache: "force-cache" });
      if(!res.ok) throw new Error("tag fetch failed");
      const text = await res.text();
      const lines = text.split(/\r?\n/);
      const keys = [];
      for(let i=1;i<lines.length;i++){
        const line = lines[i];
        if(!line) continue;
        const cols = parseCsvLine(line);
        if(cols.length < 4) continue;
        const tag = cols[0]?.trim();
        if(!tag) continue;
        const category = Number.parseInt(cols[1], 10);
        const count = Number.parseInt(cols[2], 10);
        const aliasRaw = cols[3] || "";
        const entry = { tag, category:Number.isFinite(category) ? category : 0, count:Number.isFinite(count) ? count : 0 };
        const tagKey = normalizeTagKey(tag);
        if(tagKey) keys.push({ key: tagKey, entry });
        if(aliasRaw){
          aliasRaw.split(",").forEach((alias)=>{
            const aliasKey = normalizeTagKey(alias);
            if(aliasKey) keys.push({ key: aliasKey, entry });
          });
        }
      }
      keys.sort((a,b)=>a.key.localeCompare(b.key));
      tagIndex.keys = keys;
      tagIndex.loaded = true;
    }catch(err){
      tagIndex.error = "Failed to load tags";
    }finally{
      tagIndex.loading = false;
      refreshSuggest();
    }
  }

  function lowerBound(keys, prefix){
    let lo = 0;
    let hi = keys.length;
    while(lo < hi){
      const mid = (lo + hi) >> 1;
      if(keys[mid].key.localeCompare(prefix) < 0) lo = mid + 1;
      else hi = mid;
    }
    return lo;
  }

  function findTagMatches(prefix, limit){
    if(!prefix || !tagIndex.loaded) return [];
    const keys = tagIndex.keys;
    const start = lowerBound(keys, prefix);
    const found = [];
    const seen = new Set();
    for(let i=start;i<keys.length;i++){
      const entry = keys[i];
      if(!entry.key.startsWith(prefix)) break;
      if(seen.has(entry.entry.tag)) continue;
      seen.add(entry.entry.tag);
      found.push(entry.entry);
      if(found.length >= limit) break;
    }
    return found;
  }

  function ensureSuggestEl(){
    if(tagSuggest.el) return;
    const el = document.createElement("div");
    el.className = "tagSuggest hidden";
    el.addEventListener("mousedown", (ev)=>ev.preventDefault());
    el.addEventListener("click", (ev)=>{
      const row = ev.target.closest(".item");
      if(!row) return;
      const idx = Number(row.dataset.index);
      if(Number.isFinite(idx)) applySuggest(idx);
    });
    document.body.appendChild(el);
    tagSuggest.el = el;
    document.addEventListener("click", (ev)=>{
      if(!tagSuggest.visible) return;
      if(ev.target === tagSuggest.field || tagSuggest.el.contains(ev.target)) return;
      hideSuggest();
    });
    window.addEventListener("resize", positionSuggest);
    window.addEventListener("scroll", positionSuggest, true);
  }

  function getTokenInfo(field){
    const value = field.value || "";
    const caret = field.selectionStart ?? value.length;
    const lastComma = value.lastIndexOf(",", caret - 1);
    const lastBreak = value.lastIndexOf("\n", caret - 1);
    let start = Math.max(lastComma, lastBreak);
    start = start === -1 ? 0 : start + 1;
    while(value[start] === " " || value[start] === "\t") start++;
    const raw = value.slice(start, caret);
    const trimmed = raw.trim();
    const prefix = normalizeTagKey(trimmed);
    return { start, end: caret, raw, prefix };
  }

  function positionSuggest(){
    if(!tagSuggest.visible || !tagSuggest.el || !tagSuggest.field) return;
    const rect = tagSuggest.field.getBoundingClientRect();
    const maxHeight = 260;
    const listHeight = Math.min(maxHeight, tagSuggest.el.scrollHeight || maxHeight);
    const spaceBelow = window.innerHeight - rect.bottom - 8;
    const placeAbove = spaceBelow < listHeight && rect.top > listHeight + 12;
    const top = placeAbove ? rect.top - listHeight - 8 : rect.bottom + 6;
    tagSuggest.el.style.top = `${Math.max(8, top)}px`;
    tagSuggest.el.style.left = `${Math.max(8, rect.left)}px`;
    tagSuggest.el.style.width = `${Math.max(220, rect.width)}px`;
    tagSuggest.el.style.maxHeight = `${maxHeight}px`;
  }

  function renderSuggest(items, message){
    ensureSuggestEl();
    const el = tagSuggest.el;
    el.innerHTML = "";
    if(message){
      const empty = document.createElement("div");
      empty.className = "empty";
      empty.textContent = message;
      el.appendChild(empty);
    }else{
      items.forEach((entry, idx)=>{
        const row = document.createElement("div");
        row.className = "item";
        if(idx === tagSuggest.active) row.classList.add("active");
        row.dataset.index = String(idx);
        const badge = document.createElement("span");
        badge.className = `tagBadge cat${entry.category}`;
        badge.textContent = formatTagLabel(entry.tag);
        const meta = document.createElement("span");
        meta.className = "meta";
        const count = document.createElement("span");
        count.textContent = formatTagCount.format(entry.count || 0);
        const ps = currentPromptSettings();
        let infoBtn = null;
        if(ps.useWiki){
          infoBtn = document.createElement("button");
          infoBtn.className = "tagInfoBtn";
          infoBtn.type = "button";
          infoBtn.setAttribute("aria-label", `Info for ${formatTagLabel(entry.tag)}`);
          infoBtn.innerHTML = '<i class="fa-solid fa-circle-info"></i>';
          infoBtn.addEventListener("click", (ev)=>{
            ev.preventDefault();
            ev.stopPropagation();
            openTagInfo(entry.tag, infoBtn, entry.category);
          });
        }
        meta.appendChild(count);
        if(infoBtn) meta.appendChild(infoBtn);
        row.appendChild(badge);
        row.appendChild(meta);
        row.addEventListener("mousemove", ()=>{
          if(tagSuggest.active !== idx){
            tagSuggest.active = idx;
            highlightActive();
          }
        });
        el.appendChild(row);
      });
    }
    showSuggest();
    positionSuggest();
  }

  function highlightActive(){
    if(!tagSuggest.el) return;
    const rows = tagSuggest.el.querySelectorAll(".item");
    rows.forEach((row, idx)=>{
      row.classList.toggle("active", idx === tagSuggest.active);
    });
    const activeRow = tagSuggest.el.querySelector(`.item[data-index="${tagSuggest.active}"]`);
    if(activeRow) activeRow.scrollIntoView({ block:"nearest" });
  }

  function showSuggest(){
    if(!tagSuggest.el) return;
    tagSuggest.el.classList.remove("hidden");
    tagSuggest.visible = true;
  }

  function hideSuggest(){
    if(!tagSuggest.el) return;
    tagSuggest.el.classList.add("hidden");
    tagSuggest.visible = false;
  }

  function refreshSuggest(){
    if(!tagSuggest.field) return;
    const s = currentPromptSettings();
    if(!s.useAutocomplete){
      hideSuggest();
      return;
    }
    const info = getTokenInfo(tagSuggest.field);
    tagSuggest.tokenRange = { start: info.start, end: info.end };
    if(!info.prefix){
      hideSuggest();
      return;
    }
    if(tagIndex.loading){
      renderSuggest([], "Loading tags...");
      return;
    }
    if(tagIndex.error){
      renderSuggest([], tagIndex.error);
      return;
    }

    const blacklist = parseTagBlacklist(s.tagBlacklist);
    const matches = findTagMatches(info.prefix, TAG_SUGGEST_LIMIT).filter((e)=>!blacklist.has(normalizeTagKey(e.tag)));
    if(matches.length === 0){
      hideSuggest();
      return;
    }
    tagSuggest.items = matches;
    tagSuggest.active = 0;
    renderSuggest(matches, "");
  }

  function applySuggest(index){
    if(!tagSuggest.field || !tagSuggest.items.length) return;
    const entry = tagSuggest.items[index] || tagSuggest.items[0];
    if(!entry || !tagSuggest.tokenRange) return;
    const field = tagSuggest.field;
    const value = field.value || "";
    const before = value.slice(0, tagSuggest.tokenRange.start);
    const after = value.slice(tagSuggest.tokenRange.end);
    const insert = `${formatTagLabel(entry.tag)}, `;
    const next = before + insert + after;
    field.value = next;
    const caret = before.length + insert.length;
    field.setSelectionRange(caret, caret);
    field.dispatchEvent(new Event("input", { bubbles:true }));
    closeTagInfo();
    hideSuggest();
  }

  function setupTagAutocomplete(field){
    if(!field) return;
    field.addEventListener("focus", ()=>{
      tagSuggest.field = field;
      ensureSuggestEl();
      loadTagIndex();
      refreshSuggest();
    });
    field.addEventListener("input", refreshSuggest);
    field.addEventListener("click", refreshSuggest);
    field.addEventListener("keydown", (ev)=>{
      if(!tagSuggest.visible || tagSuggest.field !== field) return;
      if(ev.key === "ArrowDown"){
        ev.preventDefault();
        tagSuggest.active = (tagSuggest.active + 1) % tagSuggest.items.length;
        highlightActive();
      }else if(ev.key === "ArrowUp"){
        ev.preventDefault();
        tagSuggest.active = (tagSuggest.active - 1 + tagSuggest.items.length) % tagSuggest.items.length;
        highlightActive();
      }else if(ev.key === "Tab"){
        ev.preventDefault();
        applySuggest(tagSuggest.active);
      }
    });
    field.addEventListener("blur", ()=>{
      setTimeout(()=>{
        if(document.activeElement !== field) hideSuggest();
      }, 120);
    });
  }

  let promptTokenizer = null;
  let promptTokenizerPromise = null;

  function loadPromptTokenizer(){
    if(promptTokenizer) return Promise.resolve(promptTokenizer);
    if(promptTokenizerPromise) return promptTokenizerPromise;
    promptTokenizerPromise = import("https://deno.land/x/clip_bpe@v0.0.6/mod.js")
      .then((mod)=>{
        promptTokenizer = new mod.default();
        return promptTokenizer;
      })
      .catch((err)=>{
        console.warn("Token counter unavailable.", err);
        promptTokenizerPromise = null;
        return null;
      });
    return promptTokenizerPromise;
  }

  function updatePromptTokenCount(field, counter){
    const ps = currentPromptSettings();
    if(!ps.useTokenCounter) return;
    if(!promptTokenizer || !field || !counter) return;
    const textNode = counter.querySelector(".tokenText");
    const warnNode = counter.querySelector(".tokenWarn");
    let prompt = String(field.value || "").trim();
    if(!prompt){
      if(textNode) textNode.textContent = `0 tkns`;
      counter.classList.remove("warn");
      if(warnNode) warnNode.classList.remove("show");
      return;
    }
    prompt = prompt.toLowerCase();
    const rawTokens = promptTokenizer.encode(prompt).length;
    const effectiveTokens = Math.min(rawTokens, TOKEN_LIMIT);
    const truncated = rawTokens > TOKEN_LIMIT;
      if(textNode) textNode.textContent = `${rawTokens} tkns`;
    const showAlert = currentPromptSettings().showTokenAlert;
    counter.classList.toggle("warn", showAlert && truncated);
    if(warnNode){
      warnNode.classList.toggle("show", showAlert && truncated);
      warnNode.title = TOKEN_WARN_TEXT;
    }
  }

  async function setupPromptTokenCounters(){
    const ps = currentPromptSettings();
    const counters = Array.from(document.querySelectorAll(".tokenCount[data-for]"));
    counters.forEach((c)=>{ c.style.display = ps.useTokenCounter ? "" : "none"; });
    if(!ps.useTokenCounter) return;
    if(!counters.length) return;
    const tokenizer = await loadPromptTokenizer();
    if(!tokenizer){
      counters.forEach((counter)=>{
        const textNode = counter.querySelector(".tokenText");
          if(textNode) textNode.textContent = "n/a";
      });
      return;
    }
    counters.forEach((counter)=>{
      const id = counter.dataset.for;
      const field = $(id);
      if(!field) return;
      const update = ()=>updatePromptTokenCount(field, counter);
      field.addEventListener("input", update);
      update();
    });
  }

const ADV_DEFAULTS = {
  mpTolerance: 0.10,
  targetMp: 1.05,
  targetMpMinAllowed: 0.50,
  targetMpMaxAllowed: 2.00,
};

function readAdvSetting(key, fallback){
  const raw = localStorage.getItem(key);
  if(raw === null || raw === undefined) return fallback;
  const n = Number(raw);
  return Number.isFinite(n) ? n : fallback;
}

function getMpTolerance(){
  const v = Number($("mpTolerance")?.value);
  return clamp(Number.isFinite(v) ? v : ADV_DEFAULTS.mpTolerance, 0.01, 0.40);
}

function getTargetMp(){
  const v = Number($("targetMp")?.value);
  return clamp(Number.isFinite(v) ? v : ADV_DEFAULTS.targetMp, ADV_DEFAULTS.targetMpMinAllowed, ADV_DEFAULTS.targetMpMaxAllowed);
}

function syncFrameInfoHeight(){
  const info = $("frameInfo");
  const canvas = $("aspectCanvas");
  if(!info || !canvas) return;

  const stacked = window.matchMedia("(max-width: 980px)").matches;
  if(stacked){
    info.style.setProperty("--frameInfoH", "auto");
    return;
  }

  const box = canvas.getBoundingClientRect();
  if(!box.height || !Number.isFinite(box.height)) return;
  info.style.setProperty("--frameInfoH", `${Math.round(box.height)}px`);
}

function updateAdvSizingBadge(){
  const badge = $("advSizingBadge");
  if(!badge) return;
  const tol = getMpTolerance();
  const target = getTargetMp();
  badge.textContent = `${target.toFixed(2)} MP ±${tol.toFixed(2)}`;
}

function updateTargetMpWarn(){
  const warn = $("targetMpWarn");
  if(!warn) return;
  const target = getTargetMp();
  const delta = target - 1.00;
  if(Math.abs(delta) <= 0.10){
    warn.textContent = "";
    warn.style.opacity = "0.75";
    return;
  }
  const dir = delta > 0 ? "above" : "below";
  warn.textContent = `Note: ${target.toFixed(2)} MP (${Math.abs(delta).toFixed(2)} MP ${dir} 1.00)`;
  warn.style.opacity = "0.75";
}

function applyAdvSizingFromUi(){
  const tol = getMpTolerance();
  const target = getTargetMp();
  $("mpTolerance").value = tol.toFixed(2);
  $("targetMp").value = target.toFixed(2);
  localStorage.setItem("bumfy_mpTol", String(tol));
  localStorage.setItem("bumfy_targetMp", String(target));
  updateAdvSizingBadge();
  updateTargetMpWarn();
}


const clientMarker = crypto.randomUUID();

let backendConnected = false;
let websocketHandle = null;

let activeJob = null;
let pendingJobs = [];
let galleryRecords = [];

let gridCellsCount = 10;

let dragActive = false;
let dragAnchor = null;

let chosenRect = { x0: 0, y0: 0, x1: 9, y1: 9 };

let derivedSize = { w: 832, h: 1216, mp: 1.01, ratioA: 13, ratioB: 19 };

let appliedQualityTagText = "";

const samplerChoices = [
  "euler","euler_ancestral","heun","dpm_2","dpm_2_ancestral","lms",
  "dpm_fast","dpm_adaptive","dpmpp_2s_ancestral","dpmpp_sde","dpmpp_sde_gpu",
  "dpmpp_2m","dpmpp_2m_sde","dpmpp_2m_sde_gpu","ddim","uni_pc","uni_pc_bh2",
  "er_sde"
];

const schedulerChoices = [
  "karras","normal","simple","ddim_uniform","sgm_uniform","exponential","polyexponential","kl_optimal"
];

function toast(msg){
  const node = $("toast");
  node.textContent = String(msg ?? "");
  node.classList.add("on");
  clearTimeout(node._t);
  node._t = setTimeout(()=>node.classList.remove("on"), 950);
}

function getBoolSetting(key, defaultOn=true){
  const raw = localStorage.getItem(key);
  if(raw === null) return defaultOn;
  return raw !== "0";
}

function currentPromptSettings(){
  return {
    useTokenCounter: $("optUseTokenCounter")?.checked ?? getBoolSetting("bumfy_useTokenCounter", true),
    showTokenAlert: $("optShowTokenAlert")?.checked ?? getBoolSetting("bumfy_showTokenAlert", true),
    useAutocomplete: $("optUseAutocomplete")?.checked ?? getBoolSetting("bumfy_useAutocomplete", true),
    useWiki: $("optUseWiki")?.checked ?? getBoolSetting("bumfy_useWiki", true),
    trimTrailingComma: $("optTrimTrailingComma")?.checked ?? getBoolSetting("bumfy_trimTrailingComma", true),
    tagBlacklist: String($("optTagBlacklist")?.value || localStorage.getItem("bumfy_tagBlacklist") || ""),
  };
}

function parseTagBlacklist(raw){
  const out = new Set();
  String(raw || "")
    .split(/[\r\n]+/)
    .map(s=>s.trim())
    .filter(Boolean)
    .forEach((tag)=>out.add(normalizeTagKey(tag)));
  return out;
}

function updatePromptsSettingsUi(){
  const s = currentPromptSettings();
  const wikiWrap = $("wikiFeaturesWrap");
  if(wikiWrap) wikiWrap.style.display = s.useAutocomplete ? "" : "none";

  // Token counter visibility
  const counters = Array.from(document.querySelectorAll(".tokenCount"));
  counters.forEach((el)=>{ el.style.display = s.useTokenCounter ? "" : "none"; });

  // If alerts disabled, hide warn badges.
  if(!s.showTokenAlert){
    document.querySelectorAll(".tokenWarn").forEach((el)=>{ el.classList.remove("show"); });
    document.querySelectorAll(".tokenCount").forEach((el)=>{ el.classList.remove("warn"); });
  }

  // If autocomplete disabled, hide suggest popup.
  if(!s.useAutocomplete) hideSuggest();
}

function refreshBaseBadge(){
  const badge = $("baseBadge");
  if(!badge) return;
  const v = String($("baseUrl").value || "").trim();
  badge.textContent = v || "—";
  badge.title = v || "Base URL";
}

function estimateLocalStorageBytesForBumfy(){
  let bytes = 0;
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(!k) continue;
    if(k.startsWith("bumfy_") || k === TAG_WIKI_CACHE_KEY){
      const v = localStorage.getItem(k) || "";
      bytes += (k.length + v.length) * 2;
    }
  }
  return bytes;
}

function updateStorageUsageUi(){
  const node = $("storageUsage");
  if(!node) return;
  const mb = estimateLocalStorageBytesForBumfy() / (1024*1024);
  node.textContent = `${mb.toFixed(2)} MB`;
}

function resetStorage(){
  const ok = window.confirm("Reset Bumfy localStorage? This will remove settings, UI snapshot, and cached tag wiki data.");
  if(!ok) return;
  for(let i=localStorage.length-1;i>=0;i--){
    const k = localStorage.key(i);
    if(!k) continue;
    if(k.startsWith("bumfy_") || k === TAG_WIKI_CACHE_KEY){
      localStorage.removeItem(k);
    }
  }
  toast("reset");
  window.location.reload();
}

function trimTrailingComma(text){
  // Remove a single trailing comma (or comma+space) at the end.
  return String(text || "").replace(/,\s*$/g, "");
}

function baseUrl(){
  return $("baseUrl").value.replace(/\/+$/,"");
}

function setBackendState(state, label, detail){
  $("backendDot").className = "dot" + (state ? " " + state : "");
  $("backendText").textContent = label || "";
  $("backendDetail").textContent = detail || "";
  backendConnected = state === "ok";
}

function setRunState(state, label, detail){
  $("runDot").className = "dot" + (state ? " " + state : "");
  $("runText").textContent = label || "";
  $("runDetail").textContent = detail || "";
}

function applyTheme(theme){
  const t = (theme || "dark").toLowerCase();
  document.documentElement.setAttribute("data-theme", ["light","dark","black"].includes(t) ? t : "dark");
}

function wsEndpoint(){
  const url = new URL(baseUrl());
  const proto = (url.protocol === "https:") ? "wss:" : "ws:";
  return `${proto}//${url.host}/ws?clientId=${encodeURIComponent(clientMarker)}`;
}

async function apiGet(path){
  const response = await fetch(baseUrl() + path, { method:"GET" });
  if(!response.ok) throw new Error(`GET ${path} -> ${response.status}`);
  return response.json();
}

async function apiPost(path, body){
  const response = await fetch(baseUrl() + path, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body ?? {})
  });
  if(!response.ok){
    const msg = await response.text().catch(()=> "");
    throw new Error(`POST ${path} -> ${response.status} ${msg}`);
  }
  return response.json().catch(()=> ({}));
}

async function pingBackend(){
  $("baseBadge").textContent = baseUrl();
  try{
    await apiGet("/queue");
    setBackendState("ok","connected","");
    return true;
  }catch(e){
    setBackendState("bad","disconnected", e.message || String(e));
    return false;
  }
}

function ensureWebsocket(){
  try{ websocketHandle?.close(); }catch(_){}
  websocketHandle = null;
  try{
    websocketHandle = new WebSocket(wsEndpoint());
    websocketHandle.onmessage = onWebsocketMessage;
  }catch(_){
    websocketHandle = null;
  }
}

function onWebsocketMessage(ev){
  if(!activeJob) return;
  let message;
  try{ message = JSON.parse(ev.data); }catch(_){ return; }

  if(message?.type === "progress" && typeof message?.data?.value === "number"){
    activeJob.progressText.textContent = `${message.data.value}/${message.data.max}`;
    setRunState("warn","running", activeJob.promptId || "");
    activeJob.stageText.textContent = "running";
  }

  if(message?.type === "executed" && message?.data?.output?.images?.length){
    const nodeId = String(message.data.node || "");
    const imageRef = message.data.output.images[0];
    const imageUrl = viewUrl(imageRef);

    if(nodeId === "12"){
      activeJob.previewUrl = imageUrl;
      activeJob.imageNode.src = imageUrl;
      activeJob.stageText.textContent = activeJob.secondPassEnabled ? "1st pass" : "final";
      if(!activeJob.secondPassEnabled) completeJob(activeJob, true);
    }

    if(nodeId === "21"){
      activeJob.finalUrl = imageUrl;
      activeJob.imageNode.src = imageUrl;
      activeJob.stageText.textContent = "final";
      completeJob(activeJob, true);
    }
  }
}

function viewUrl(imageRef){
  const query = new URLSearchParams();
  query.set("filename", imageRef.filename);
  if(imageRef.type) query.set("type", imageRef.type);
  if(imageRef.subfolder) query.set("subfolder", imageRef.subfolder);
  return baseUrl() + "/view?" + query.toString();
}

function normalizeRatio(a,b){
  const gcd = (x,y)=>y?gcd(y,x%y):Math.abs(x);
  const d = gcd(a,b) || 1;
  return { a: Math.max(1, Math.round(a/d)), b: Math.max(1, Math.round(b/d)) };
}

function computeRatioFromRect(rect){
  const w = Math.max(1, Math.abs(rect.x1 - rect.x0) + 1);
  const h = Math.max(1, Math.abs(rect.y1 - rect.y0) + 1);
  return normalizeRatio(w,h);
}


function chooseResolutionForRatio(ratioA, ratioB, targetMp, mpTolerance){
  // Consider every 8px-snapped W x H in bounds, then pick the best.
  // Preference order:
  // 1) within MP tolerance (targetMp ± mpTolerance)
  // 2) closest aspect ratio
  // 3) closest MP
  const minSide = 512;
  const maxSide = 2048;
  const step = 8;

  const desired = ratioA / ratioB;
  const tol = clamp(Number.isFinite(mpTolerance) ? mpTolerance : 0.10, 0.01, 0.40);

  let bestInTol = null;
  let bestAny = null;
  let bestInTolAspect = Infinity;
  let bestAnyAspect = Infinity;
  const aspectEps = 1e-6;

  for(let w=minSide; w<=maxSide; w+=step){
    for(let h=minSide; h<=maxSide; h+=step){
      const pixels = w * h;
      const mp = pixels / 1_000_000;
      const ratio = w / h;
      const aspectError = Math.abs(ratio - desired);
      const mpError = Math.abs(mp - targetMp);

      const rec = { w, h, mp, aspectError, mpError };

      if(aspectError < bestAnyAspect - aspectEps){
        bestAnyAspect = aspectError;
        bestAny = rec;
      }else if(Math.abs(aspectError - bestAnyAspect) <= aspectEps && (!bestAny || mpError < bestAny.mpError)){
        bestAny = rec;
      }

      if(mpError <= tol){
        if(aspectError < bestInTolAspect - aspectEps){
          bestInTolAspect = aspectError;
          bestInTol = rec;
        }else if(Math.abs(aspectError - bestInTolAspect) <= aspectEps && (!bestInTol || mpError < bestInTol.mpError)){
          bestInTol = rec;
        }
      }
    }
  }

  return bestInTol || bestAny || { w: 1024, h: 1024, mp: 1.05, aspectError: 0, mpError: 0 };
}


function updateSizeBadges(){
  const baseW = derivedSize.w;
  const baseH = derivedSize.h;
  const batch = clamp(parseInt($("batchSize").value || "1",10), 1, 16);

  const refineOn = $("enableSecondPass").checked && $("enableUpscale").checked;
  const conceptualScale = clamp(Number($("conceptScale").value || "1.50"), 1.0, 2.0);
  const finalW = refineOn ? Math.max(1, Math.round(baseW * conceptualScale)) : baseW;
  const finalH = refineOn ? Math.max(1, Math.round(baseH * conceptualScale)) : baseH;

  const finalMp = (finalW * finalH) / 1_000_000;
  const aspectText = `${derivedSize.ratioA}:${derivedSize.ratioB}`;

  $("baseSizeText").textContent = `${baseW}x${baseH}`;
  $("finalSizeText").textContent = `${finalW}x${finalH}`;
  $("finalMpText").textContent = `(${finalMp.toFixed(2)} MP)`;
  $("finalAspectText").textContent = aspectText;

  const sizeSectionText = (refineOn && (baseW !== finalW || baseH !== finalH))
    ? `${baseW}x${baseH} -> ${finalW}x${finalH}`
    : `${finalW}x${finalH}`;
  const batchLabel = batch === 1 ? "1 img" : `${batch} imgs`;
  if($("sizeSectionBadge")) $("sizeSectionBadge").textContent = `${batchLabel} · ${sizeSectionText}`;

  $("targetMpBadge").textContent = getTargetMp().toFixed(2);

  $("scaleBadge").textContent = `${conceptualScale.toFixed(2)}x`;


  const baseMp = (baseW * baseH) / 1_000_000;
  const targetMp = getTargetMp();
  const mpWarn = $("mpWarnWrap");
  if(mpWarn) mpWarn.style.display = (targetMp > 1.10 && baseMp > 1.10) ? "" : "none";
  const mpWarnLow = $("mpWarnLowWrap");
  if(mpWarnLow) mpWarnLow.style.display = (targetMp < 0.90 && baseMp < 0.90) ? "" : "none";

  const sb = $("seedBadge");
  if(sb) sb.textContent = $("seedMode").value === "random" ? "random seed" : String($("seedValue").value || "-");
}

function syncCustomSizeInputs(){
  const customOn = $("customSizeEnabled").checked;
  $("customWidth").disabled = !customOn;
  $("customHeight").disabled = !customOn;
  const fields = $("customSizeFields");
  if(fields) fields.classList.toggle("is-disabled", !customOn);
}

function updateDerivedSizeFromSketch(){
  const customOn = $("customSizeEnabled").checked;
  syncCustomSizeInputs();

  if(customOn){
    const w = clamp(roundStep(Number($("customWidth").value), 8), 64, 4096);
    const h = clamp(roundStep(Number($("customHeight").value), 8), 64, 4096);
    $("customWidth").value = String(w);
    $("customHeight").value = String(h);
    const ratio = normalizeRatio(w,h);
    derivedSize = { w, h, mp: (w*h)/1_000_000, ratioA: ratio.a, ratioB: ratio.b };
    updateSizeBadges();
    syncFrameInfoHeight();
    return;
  }

  const ratio = computeRatioFromRect(chosenRect);
  const target = getTargetMp();
  const tol = getMpTolerance();
  const chosen = chooseResolutionForRatio(ratio.a, ratio.b, target, tol);
  derivedSize = { w: chosen.w, h: chosen.h, mp: chosen.mp, ratioA: ratio.a, ratioB: ratio.b };

  $("customWidth").value = String(derivedSize.w);
  $("customHeight").value = String(derivedSize.h);

  updateSizeBadges();
  syncFrameInfoHeight();
}

function canvasToCell(ev){
  const canvas = $("aspectCanvas");
  const box = canvas.getBoundingClientRect();
  const px = clamp(ev.clientX - box.left, 0, box.width - 0.0001);
  const py = clamp(ev.clientY - box.top, 0, box.height - 0.0001);
  const cellX = clamp(Math.floor((px / box.width) * gridCellsCount), 0, gridCellsCount - 1);
  const cellY = clamp(Math.floor((py / box.height) * gridCellsCount), 0, gridCellsCount - 1);
  return { cellX, cellY };
}

function rectNormalized(rect){
  const xMin = Math.min(rect.x0, rect.x1);
  const xMax = Math.max(rect.x0, rect.x1);
  const yMin = Math.min(rect.y0, rect.y1);
  const yMax = Math.max(rect.y0, rect.y1);
  const x0 = clamp(xMin, 0, gridCellsCount - 1);
  const x1 = clamp(xMax + 1, 1, gridCellsCount);
  const y0 = clamp(yMin, 0, gridCellsCount - 1);
  const y1 = clamp(yMax + 1, 1, gridCellsCount);
  return { x0, y0, x1, y1 };
}

function resizeAspectCanvas(){
  const canvas = $("aspectCanvas");
  if(!canvas) return;
  const box = canvas.getBoundingClientRect();
  const size = Math.floor(Math.min(box.width, box.height));
  if(!size || !Number.isFinite(size)) return;
  const dpr = window.devicePixelRatio || 1;
  const pxSize = Math.max(1, Math.round(size * dpr));
  if(canvas.width !== pxSize || canvas.height !== pxSize){
    canvas.width = pxSize;
    canvas.height = pxSize;
  }
}

function drawAspectCanvas(){
  const canvas = $("aspectCanvas");
  resizeAspectCanvas();
  const ctx = canvas.getContext("2d");
  const w = canvas.width;
  const h = canvas.height;

  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = "#07080b";
  ctx.fillRect(0,0,w,h);

  const cell = w / gridCellsCount;

  ctx.strokeStyle = "rgba(255,255,255,.09)";
  ctx.lineWidth = 1;

  for(let i=1;i<gridCellsCount;i++){
    const p = Math.round(i * cell) + 0.5;
    ctx.beginPath();
    ctx.moveTo(p, 0);
    ctx.lineTo(p, h);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(0, p);
    ctx.lineTo(w, p);
    ctx.stroke();
  }

  const r = rectNormalized(chosenRect);

  ctx.fillStyle = "rgba(224,106,106,.10)";
  ctx.fillRect(r.x0*cell, r.y0*cell, (r.x1-r.x0)*cell, (r.y1-r.y0)*cell);

  ctx.strokeStyle = "rgba(224,106,106,.95)";
  ctx.lineWidth = 2;
  ctx.strokeRect(r.x0*cell + 1, r.y0*cell + 1, (r.x1-r.x0)*cell - 2, (r.y1-r.y0)*cell - 2);
}

function attachCanvasEvents(){
  const canvas = $("aspectCanvas");

  const start = (ev)=>{
    ev.preventDefault();
    if($("customSizeEnabled").checked) return;
    const p = canvasToCell(ev);
    dragActive = true;
    dragAnchor = { x: p.cellX, y: p.cellY };
    chosenRect = { x0: dragAnchor.x, y0: dragAnchor.y, x1: dragAnchor.x, y1: dragAnchor.y };
    drawAspectCanvas();
  };

  const move = (ev)=>{
    if(!dragActive) return;
    ev.preventDefault();
    const p = canvasToCell(ev);
    chosenRect = { x0: dragAnchor.x, y0: dragAnchor.y, x1: p.cellX, y1: p.cellY };
    drawAspectCanvas();
  };

  const end = (ev)=>{
    if(!dragActive) return;
    ev.preventDefault();
    dragActive = false;
    updateDerivedSizeFromSketch();
  };

  canvas.addEventListener("pointerdown", start);
  window.addEventListener("pointermove", move);
  window.addEventListener("pointerup", end);
  window.addEventListener("pointercancel", end);
}

function resetSketch(){
  // Default: full 10x10 selection in a 10x10 grid.
  chosenRect = { x0: 0, y0: 0, x1: 9, y1: 9 };
  drawAspectCanvas();
  updateDerivedSizeFromSketch();
}

function syncRefineVisibility(){
  const on = $("enableSecondPass").checked;
  $("refineBadge").textContent = on ? "on" : "off";
  $("secondPassSettings").style.display = on ? "" : "none";
  const canEditSecondPrompts = on && $("editSecondPrompts").checked;
  $("secondPromptBlock").style.display = canEditSecondPrompts ? "" : "none";
  updateSizeBadges();
}

function syncSeedMode(){
  const mode = $("seedMode").value;
  const isRandom = mode === "random";
  $("seedValue").disabled = isRandom;
  updateSizeBadges();
}

function randomSeed(){
  return Math.floor(Math.random() * 2147483647);
}

function computeSeedForJob(){
  const mode = $("seedMode").value;
  const current = Number($("seedValue").value);
  const safeCurrent = Number.isFinite(current) ? Math.trunc(current) : 791;

  if(mode === "random") return randomSeed();
  if(mode === "fixed") return safeCurrent;

  const next = safeCurrent;
  $("seedValue").value = String(safeCurrent + 1);
  return next;
}

function buildPromptText(positiveText){
  const tags = (appliedQualityTagText || "").trim();
  const base = (positiveText || "").trim();
  if(!tags) return base;
  if(!base) return tags;
  return `${tags}, ${base}`;
}

function buildWorkflowGraph(jobSeed){
  const secondPass = $("enableSecondPass").checked;
  const upscale = $("enableUpscale").checked;
  const conceptualScale = clamp(Number($("conceptScale").value || "1.50"), 1.0, 2.0);
  const internalDownscale = clamp(conceptualScale/2, 0.10, 1.20);

  const ps = currentPromptSettings();
  if(ps.trimTrailingComma){
    for(const id of ["positivePrompt","negativePrompt","positivePrompt2","negativePrompt2"]){
      const el = $(id);
      if(!el) continue;
      const raw = String(el.value || "");
      const cleaned = trimTrailingComma(raw);
      if(cleaned !== raw) el.value = cleaned;
    }
  }

  const firstPos = buildPromptText($("positivePrompt").value);
  const firstNeg = String($("negativePrompt").value || "").trim();

  const secondUsesSeparatePrompts = secondPass && $("editSecondPrompts").checked;
  const secondPos = secondUsesSeparatePrompts ? buildPromptText($("positivePrompt2").value) : firstPos;
  const secondNeg = secondUsesSeparatePrompts ? String($("negativePrompt2").value || "").trim() : firstNeg;

  const checkpointName = $("checkpointName").value;
  const batchSize = clamp(parseInt($("batchSize").value || "1",10), 1, 16);

  const samplerName = $("samplerName").value || "er_sde";
  const schedulerName = $("schedulerName").value || "kl_optimal";

  const steps1 = clamp(parseInt($("steps1").value || "24",10), 1, 200);
  const cfg1 = clamp(Number($("cfg1").value || "6"), 0, 30);

  const steps2 = clamp(parseInt($("steps2").value || "18",10), 1, 200);
  const cfg2 = clamp(Number($("cfg2").value || "6"), 0, 30);
  const denoise2 = clamp(Number($("denoise2").value || "0.52"), 0.01, 1.0);

  const width = derivedSize.w;
  const height = derivedSize.h;

  const graph = {};

  graph["1"] = {
    inputs:{ ckpt_name: checkpointName },
    class_type:"CheckpointLoaderSimple",
    _meta:{ title:"Load Checkpoint" }
  };

  graph["7"] = {
    inputs:{ text:firstPos, clip:["1",1] },
    class_type:"CLIPTextEncode",
    _meta:{ title:"CLIP Text Encode (Positive Prompt)" }
  };

  graph["8"] = {
    inputs:{ text:firstNeg, clip:["1",1] },
    class_type:"CLIPTextEncode",
    _meta:{ title:"CLIP Text Encode (Negative Prompt)" }
  };

  graph["10"] = {
    inputs:{ width, height, batch_size: batchSize },
    class_type:"EmptyLatentImage",
    _meta:{ title:"Empty Latent Image" }
  };

  graph["9"] = {
    inputs:{
      seed: jobSeed,
      steps: steps1,
      cfg: cfg1,
      sampler_name: samplerName,
      scheduler: schedulerName,
      denoise: 1,
      model:["1",0],
      positive:["7",0],
      negative:["8",0],
      latent_image:["10",0]
    },
    class_type:"KSampler",
    _meta:{ title:"KSampler (Pass 1)" }
  };

  graph["11"] = {
    inputs:{ samples:["9",0], vae:["1",2] },
    class_type:"VAEDecode",
    _meta:{ title:"VAE Decode (Pass 1)" }
  };

  graph["12"] = {
    inputs:{ images:["11",0] },
    class_type:"PreviewImage",
    _meta:{ title:"First Pass Image" }
  };

  if(!secondPass){
    return { graph, secondPassEnabled:false };
  }

  graph["14"] = {
    inputs:{ model_name:"RealESRGAN_x2.pth" },
    class_type:"UpscaleModelLoader",
    _meta:{ title:"Load Upscale Model" }
  };

  if(upscale){
    graph["13"] = {
      inputs:{ upscale_model:["14",0], image:["11",0] },
      class_type:"ImageUpscaleWithModel",
      _meta:{ title:"Upscale Image" }
    };

    graph["23"] = {
      inputs:{ upscale_method:"lanczos", scale_by: internalDownscale, image:["13",0] },
      class_type:"ImageScaleBy",
      _meta:{ title:"Scale Image" }
    };

    graph["15"] = {
      inputs:{ pixels:["23",0], vae:["1",2] },
      class_type:"VAEEncode",
      _meta:{ title:"VAE Encode" }
    };
  } else {
    graph["15"] = {
      inputs:{ pixels:["11",0], vae:["1",2] },
      class_type:"VAEEncode",
      _meta:{ title:"VAE Encode" }
    };
  }

  graph["17"] = {
    inputs:{ text:secondPos, clip:["1",1] },
    class_type:"CLIPTextEncode",
    _meta:{ title:"CLIP Text Encode (Positive Prompt) (Pass 2)" }
  };

  graph["18"] = {
    inputs:{ text:secondNeg, clip:["1",1] },
    class_type:"CLIPTextEncode",
    _meta:{ title:"CLIP Text Encode (Negative Prompt) (Pass 2)" }
  };

  graph["16"] = {
    inputs:{
      seed: jobSeed,
      steps: steps2,
      cfg: cfg2,
      sampler_name: samplerName,
      scheduler: schedulerName,
      denoise: denoise2,
      model:["1",0],
      positive:["17",0],
      negative:["18",0],
      latent_image:["15",0]
    },
    class_type:"KSampler",
    _meta:{ title:"KSampler (Pass 2)" }
  };

  graph["22"] = {
    inputs:{ samples:["16",0], vae:["1",2] },
    class_type:"VAEDecode",
    _meta:{ title:"VAE Decode (Pass 2)" }
  };

  graph["21"] = {
    inputs:{ images:["22",0] },
    class_type:"PreviewImage",
    _meta:{ title:"Second Pass Image" }
  };

  return { graph, secondPassEnabled:true };
}

async function queuePrompt(graph){
  return apiPost("/prompt", { prompt: graph, client_id: clientMarker });
}

async function fetchHistory(promptId){
  const data = await apiGet(`/history/${encodeURIComponent(promptId)}`);
  return data?.[promptId] || null;
}

function imageUrlFromHistory(entry, nodeId){
  const out = entry?.outputs?.[nodeId];
  const im = out?.images?.[0];
  return im ? viewUrl(im) : null;
}

async function interruptBackend(){
  const attempts = [
    ()=>apiPost("/interrupt", {}),
    ()=>apiPost("/queue/interrupt", {}),
    ()=>apiPost("/stop", {})
  ];
  for(const fn of attempts){
    try{ await fn(); return true; }catch(_){}
  }
  return false;
}

function saveImage(url, name){
  if(!url){ toast("no image"); return; }
  fetch(url).then(r => {
    if(!r.ok) throw new Error(String(r.status));
    return r.blob();
  }).then(blob => {
    const anchor = document.createElement("a");
    anchor.href = URL.createObjectURL(blob);
    anchor.download = name || "image.png";
    document.body.appendChild(anchor);
    anchor.click();
    anchor.remove();
    setTimeout(()=>URL.revokeObjectURL(anchor.href), 1200);
  }).catch(()=>toast("download failed"));
}

async function copyText(text){
  try{ await navigator.clipboard.writeText(String(text || "")); toast("copied"); }
  catch{ toast("copy failed"); }
}

function snapshotInputs(){
  return {
    positivePrompt: $("positivePrompt").value,
    negativePrompt: $("negativePrompt").value,
    positivePrompt2: $("positivePrompt2").value,
    negativePrompt2: $("negativePrompt2").value,
    checkpointName: $("checkpointName").value,
    steps1: $("steps1").value,
    cfg1: $("cfg1").value,
    samplerName: $("samplerName").value,
    schedulerName: $("schedulerName").value,
    steps2: $("steps2").value,
    cfg2: $("cfg2").value,
    denoise2: $("denoise2").value,
    batchSize: $("batchSize").value,
    seedMode: $("seedMode").value,
    seedValue: $("seedValue").value,
    targetMp: $("targetMp").value,
    chosenRect: { ...chosenRect },
    derivedSize: { ...derivedSize },
    customSizeEnabled: $("customSizeEnabled").checked,
    customWidth: $("customWidth").value,
    customHeight: $("customHeight").value,
    enableSecondPass: $("enableSecondPass").checked,
    editSecondPrompts: $("editSecondPrompts").checked,
    enableUpscale: $("enableUpscale").checked,
    conceptScale: $("conceptScale").value,
    appliedQualityTagText
  };
}

function applySnapshot(s){
  $("positivePrompt").value = s.positivePrompt || "";
  $("negativePrompt").value = s.negativePrompt || "";
  $("positivePrompt2").value = s.positivePrompt2 || "";
  $("negativePrompt2").value = s.negativePrompt2 || "";
  if(s.checkpointName) $("checkpointName").value = s.checkpointName;
  if(s.steps1) $("steps1").value = s.steps1;
  if(s.cfg1) $("cfg1").value = s.cfg1;
  if(s.samplerName) $("samplerName").value = s.samplerName;
  if(s.schedulerName) $("schedulerName").value = s.schedulerName;
  if(s.steps2) $("steps2").value = s.steps2;
  if(s.cfg2) $("cfg2").value = s.cfg2;
  if(s.denoise2) $("denoise2").value = s.denoise2;
  if(s.batchSize) $("batchSize").value = s.batchSize;
  if(s.seedMode) $("seedMode").value = s.seedMode;
  if(s.seedValue) $("seedValue").value = s.seedValue;

  if(s.targetMp) $("targetMp").value = s.targetMp;

  if(s.chosenRect) chosenRect = { ...s.chosenRect };
  if(s.derivedSize) derivedSize = { ...s.derivedSize };

  $("customSizeEnabled").checked = !!s.customSizeEnabled;
  if(s.customWidth) $("customWidth").value = s.customWidth;
  if(s.customHeight) $("customHeight").value = s.customHeight;

  $("enableSecondPass").checked = !!s.enableSecondPass;
  $("editSecondPrompts").checked = !!s.editSecondPrompts;
  $("enableUpscale").checked = s.enableUpscale !== false;
  if(s.conceptScale) $("conceptScale").value = s.conceptScale;

  appliedQualityTagText = String(s.appliedQualityTagText || "").trim();
  refreshQualityBadge();

  drawAspectCanvas();
  updateDerivedSizeFromSketch();
  syncRefineVisibility();
  syncSeedMode();
  refreshSamplerSchedulerBadge();
}

function makeGalleryCard(record){
  const card = document.createElement("div");
  card.className = "card";

  const image = document.createElement("img");
  image.alt = "result";
  image.src = record.previewUrl || "";

  const meta = document.createElement("div");
  meta.className = "cardMeta";

  const top = document.createElement("div");
  top.className = "cardTop";

  const stage = document.createElement("div");
  stage.className = "cardStage";

  const stagePill = document.createElement("span");
  stagePill.className = "pill";
  const stageText = document.createElement("span");
  stageText.className = "mono";
  stageText.textContent = record.stage || "queued";
  const progressText = document.createElement("span");
  progressText.className = "mono";
  progressText.style.opacity = ".9";
  progressText.textContent = record.progress || "";
  stagePill.appendChild(stageText);
  stagePill.appendChild(progressText);

  const metaPill = document.createElement("span");
  metaPill.className = "pill";
  metaPill.innerHTML = `<span class="thin">SIZE</span><span class="mono">${record.sizeLabel}</span>`;

  const seedPill = document.createElement("span");
  seedPill.className = "pill";
  seedPill.innerHTML = `<span class="thin">SEED</span><span class="mono">${record.seedLabel}</span>`;

  stage.appendChild(stagePill);
  stage.appendChild(metaPill);
  stage.appendChild(seedPill);

  const actions = document.createElement("div");
  actions.className = "cardActions";

  const btnCopy = document.createElement("button");
  btnCopy.className = "btn tiny";
  btnCopy.type = "button";
  btnCopy.title = "Copy prompt";
  btnCopy.innerHTML = `<i class="fa-regular fa-copy"></i>`;
  btnCopy.addEventListener("click", (ev)=>{ ev.stopPropagation(); copyText(record.promptText); });

  const btnSave = document.createElement("button");
  btnSave.className = "btn tiny";
  btnSave.type = "button";
  btnSave.title = "Download";
  btnSave.innerHTML = `<i class="fa-solid fa-download"></i>`;
  btnSave.addEventListener("click", (ev)=>{ ev.stopPropagation(); saveImage(record.finalUrl || record.previewUrl, `bumfy_${Date.now()}.png`); });

  const btnRequeue = document.createElement("button");
  btnRequeue.className = "btn tiny";
  btnRequeue.type = "button";
  btnRequeue.title = "Re-queue";
  btnRequeue.innerHTML = `<i class="fa-solid fa-rotate-right"></i>`;
  btnRequeue.addEventListener("click", (ev)=>{ ev.stopPropagation(); enqueueJob(record.snapshot, true); });

  const btnRemove = document.createElement("button");
  btnRemove.className = "btn tiny danger";
  btnRemove.type = "button";
  btnRemove.title = "Remove";
  btnRemove.innerHTML = `<i class="fa-solid fa-xmark"></i>`;
  btnRemove.addEventListener("click", (ev)=>{ ev.stopPropagation(); galleryRecords = galleryRecords.filter(x => x !== record); renderGallery(); });

  actions.appendChild(btnCopy);
  actions.appendChild(btnSave);
  actions.appendChild(btnRequeue);
  actions.appendChild(btnRemove);

  top.appendChild(stage);
  top.appendChild(actions);

  const fold = document.createElement("details");
  fold.className = "promptFold";
  const sum = document.createElement("summary");
  sum.textContent = "prompt";
  const body = document.createElement("div");
  body.className = "detailsBody";
  body.textContent = record.promptText || "";
  fold.appendChild(sum);
  fold.appendChild(body);

  meta.appendChild(top);
  meta.appendChild(fold);

  card.appendChild(image);
  card.appendChild(meta);

  record.cardNode = card;
  record.imageNode = image;
  record.stageText = stageText;
  record.progressText = progressText;

  return record;
}

function renderGallery(){
  const container = $("galleryCards");
  container.innerHTML = "";
  for(const record of galleryRecords){
    container.appendChild(record.cardNode);
  }
}

function refreshFooterMeta(){
  if(activeJob){
    $("queueMeta").textContent = `running · ${activeJob.promptId || ""}`.trim();
    return;
  }
  if(pendingJobs.length){
    $("queueMeta").textContent = `queued · ${pendingJobs.length} pending`;
    return;
  }
  $("queueMeta").textContent = "idle";
}

function refreshSamplerSchedulerBadge(){
  const s = $("samplerName").value || "—";
  const sch = $("schedulerName").value || "—";
  const steps = $("steps1") ? String($("steps1").value || "—") : "—";
  const cfg = $("cfg1") ? String($("cfg1").value || "—") : "—";
  const text = `${s} / ${sch} · ${steps} steps · cfg ${cfg}`;
  $("samplerSchedulerBadge").textContent = text;
}

function refreshModelBadge(){
  const v = $("checkpointName").value || "—";
  const el = $("modelBadge");
  if(el) el.textContent = v.split(/[\/]/).slice(-1)[0];
}

function refreshQualityBadge(){
  const txt = (appliedQualityTagText || "").trim();
  $("tagsBadge").textContent = txt ? "applied" : "none";
}

function buildQualityPresetKey(modelName){
  const clean = String(modelName || "default");
  return `bumfy_quality_presets:${clean}`;
}

function loadQualityPresetIndex(){
  const modelName = $("checkpointName").value || "default";
  const key = buildQualityPresetKey(modelName);
  let items = [];
  try{
    items = JSON.parse(localStorage.getItem(key) || "[]");
    if(!Array.isArray(items)) items = [];
  }catch(_){
    items = [];
  }
  return { key, items };
}

function setQualityPresetSelect(){
  const select = $("qualityPresetSelect");
  const { items } = loadQualityPresetIndex();
  select.innerHTML = "";
  const none = document.createElement("option");
  none.value = "";
  none.textContent = "presets";
  select.appendChild(none);

  for(const item of items){
    const opt = document.createElement("option");
    opt.value = item.name;
    opt.textContent = item.name;
    select.appendChild(opt);
  }
}

function loadSelectedPreset(){
  const modelName = $("checkpointName").value || "default";
  const selected = $("qualityPresetSelect").value || "";
  if(!selected){ toast("pick a preset"); return; }

  const { items } = loadQualityPresetIndex();
  const found = items.find(x => x.name === selected);
  if(!found){ toast("not found"); return; }

  appliedQualityTagText = String(found.tags || "").trim();
  refreshQualityBadge();
  toast("loaded");
}

function savePresetFromPrompt(){
  const modelName = $("checkpointName").value || "default";
  const name = prompt("Preset name?");
  if(!name) return;

  const tags = prompt("Tags text to apply before positive prompt (comma-separated)?", appliedQualityTagText || "");
  if(tags === null) return;

  const { key, items } = loadQualityPresetIndex();
  const next = items.filter(x => x.name !== name);
  next.unshift({ name, tags: String(tags || "").trim() });
  localStorage.setItem(key, JSON.stringify(next.slice(0, 50)));

  appliedQualityTagText = String(tags || "").trim();
  refreshQualityBadge();
  setQualityPresetSelect();
  $("qualityPresetSelect").value = name;
  toast("saved");
}

function clearAppliedTags(){
  appliedQualityTagText = "";
  refreshQualityBadge();
  toast("cleared");
}

async function fetchCheckpointNames(){
  try{
    const info = await apiGet("/object_info");
    const list = info?.CheckpointLoaderSimple?.input?.required?.ckpt_name?.[0];
    if(Array.isArray(list) && list.length) return list;
  }catch(_){}
  try{
    const response = await apiGet("/models/checkpoints");
    if(Array.isArray(response) && response.length) return response.map(v => (v.name ?? v));
    if(Array.isArray(response?.models)) return response.models.map(v => (v.name ?? v));
  }catch(_){}
  return [];
}

function loadSamplerChoices(){
  const select = $("samplerName");
  select.innerHTML = "";
  for(const name of samplerChoices){
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
  }
  select.value = "er_sde";
}

function loadSchedulerChoices(){
  const select = $("schedulerName");
  select.innerHTML = "";
  for(const name of schedulerChoices){
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
  }
  select.value = "kl_optimal";
}

async function loadCheckpoints(){
  const names = await fetchCheckpointNames();
  const select = $("checkpointName");
  select.innerHTML = "";
  if(!names.length){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "no checkpoints found";
    select.appendChild(opt);
    select.value = "";
    refreshModelBadge();
    setQualityPresetSelect();
    return;
  }
  for(const name of names){
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
  }
  select.selectedIndex = 0;
  refreshModelBadge();
  setQualityPresetSelect();
}

function toggleSettingsDrawer(){
  const drawer = $("settingsDrawer");
  const btn = $("openSettings");
  const willOpen = !drawer.classList.contains("on");
  if(!willOpen){
    if(!confirmCloseIfDirty()) return;
  }
  const isOpen = drawer.classList.toggle("on");
  if(btn){
    btn.classList.toggle("active", isOpen);
    btn.setAttribute("aria-expanded", String(isOpen));
  }
}

function closeSettingsDrawer(){
  if(!confirmCloseIfDirty()) return;
  const drawer = $("settingsDrawer");
  const btn = $("openSettings");
  drawer.classList.remove("on");
  if(btn){
    btn.classList.remove("active");
    btn.setAttribute("aria-expanded", "false");
  }
}

  let settingsDirty = false;

  function setSettingsDirty(flag){
    settingsDirty = !!flag;
  }

  function markSettingsDirty(){
    settingsDirty = true;
  }

  function confirmCloseIfDirty(){
    if(!settingsDirty) return true;
    return window.confirm("You have unsaved settings. Close without saving?");
  }


function setSectionCollapsed(btnId, bodyId, collapsed){
  const btn = $(btnId);
  const body = $(bodyId);
  if(!btn || !body) return;
  body.style.display = collapsed ? "none" : "";
  btn.classList.toggle("collapsed", collapsed);
}

function saveSettings(){
  localStorage.setItem("bumfy_baseUrl", $("baseUrl").value);
  localStorage.setItem("bumfy_theme", $("themeSelect").value);

  // Prompt options
  localStorage.setItem("bumfy_useTokenCounter", $("optUseTokenCounter").checked ? "1" : "0");
  localStorage.setItem("bumfy_showTokenAlert", $("optShowTokenAlert").checked ? "1" : "0");
  localStorage.setItem("bumfy_useAutocomplete", $("optUseAutocomplete").checked ? "1" : "0");
  localStorage.setItem("bumfy_useWiki", $("optUseWiki").checked ? "1" : "0");
  localStorage.setItem("bumfy_tagBlacklist", String($("optTagBlacklist").value || ""));
  localStorage.setItem("bumfy_trimTrailingComma", $("optTrimTrailingComma").checked ? "1" : "0");

  // Sizing
  applyAdvSizingFromUi();

  localStorage.setItem("bumfy_ui_snapshot", JSON.stringify(snapshotInputs()));
  applyTheme($("themeSelect").value);
  updateStorageUsageUi();
  setSettingsDirty(false);
  toast("saved");
}

function restoreSettings(){
  const savedBase = localStorage.getItem("bumfy_baseUrl");
  const savedTheme = localStorage.getItem("bumfy_theme");
  const savedSnap = localStorage.getItem("bumfy_ui_snapshot");

  if(savedBase) $("baseUrl").value = savedBase;
  if(savedTheme) $("themeSelect").value = savedTheme;
  applyTheme($("themeSelect").value);

  // Prompt defaults
  $("optUseTokenCounter").checked = localStorage.getItem("bumfy_useTokenCounter") !== "0";
  $("optShowTokenAlert").checked = localStorage.getItem("bumfy_showTokenAlert") !== "0";
  $("optUseAutocomplete").checked = localStorage.getItem("bumfy_useAutocomplete") !== "0";
  $("optUseWiki").checked = localStorage.getItem("bumfy_useWiki") !== "0";
  $("optTagBlacklist").value = String(localStorage.getItem("bumfy_tagBlacklist") || "");
  $("optTrimTrailingComma").checked = localStorage.getItem("bumfy_trimTrailingComma") !== "0";

  // Sizing defaults
  $("mpTolerance").value = String(readAdvSetting("bumfy_mpTol", ADV_DEFAULTS.mpTolerance));
  $("targetMp").value = String(readAdvSetting("bumfy_targetMp", ADV_DEFAULTS.targetMp));
  updateAdvSizingBadge();
  updateTargetMpWarn();

  updatePromptsSettingsUi();
  updateStorageUsageUi();
  syncFrameInfoHeight();

  // Collapsible sections
  const sizeCollapsed = localStorage.getItem("bumfy_collapse_size") === "1";
  const modelCollapsed = localStorage.getItem("bumfy_collapse_model") === "1";
  setSectionCollapsed("toggleSizeSection", "sizeSectionBody", sizeCollapsed);
  setSectionCollapsed("toggleModelSettings", "modelSettingsBody", modelCollapsed);

  if(savedSnap){
    try{
      const parsed = JSON.parse(savedSnap);
      if(parsed && typeof parsed === "object") applySnapshot(parsed);
    }catch(_){ }
  } else {
    updateDerivedSizeFromSketch();
    syncRefineVisibility();
    syncSeedMode();
    refreshSamplerSchedulerBadge();
    refreshModelBadge();
    refreshQualityBadge();
  }

  setSettingsDirty(false);
}

function bindSplitResizer(){
  const handle = $("splitHandle");
  const createPanel = $("createPanel");
  const mainSplit = $("mainSplit");
  let dragging = false;

  const begin = (ev)=>{
    ev.preventDefault();
    dragging = true;
    handle.setPointerCapture(ev.pointerId);
  };

  const move = (ev)=>{
    if(!dragging) return;
    const box = mainSplit.getBoundingClientRect();
    const x = clamp(ev.clientX - box.left, 320, box.width - 340);
    createPanel.style.width = `${Math.round(x)}px`;
    localStorage.setItem("bumfy_splitWidth", String(Math.round(x)));
    syncFrameInfoHeight();
    drawAspectCanvas();
  };

  const end = (ev)=>{
    if(!dragging) return;
    dragging = false;
    try{ handle.releasePointerCapture(ev.pointerId); }catch(_){}
  };

  handle.addEventListener("pointerdown", begin);
  handle.addEventListener("pointermove", move);
  handle.addEventListener("pointerup", end);
  handle.addEventListener("pointercancel", end);

  const saved = localStorage.getItem("bumfy_splitWidth");
  if(saved){
    const px = clamp(parseInt(saved,10), 360, 760);
    createPanel.style.width = `${px}px`;
    syncFrameInfoHeight();
    drawAspectCanvas();
  }
}

function enqueueJob(optionalSnapshot, runNow){
  if(!backendConnected){
    toast("not connected");
    return;
  }

  const snapshot = optionalSnapshot ? JSON.parse(JSON.stringify(optionalSnapshot)) : snapshotInputs();
  const seedResolved = computeSeedForJob();

  snapshot.seedResolved = seedResolved;

  const refineOn = snapshot.enableSecondPass && snapshot.enableUpscale;
  const conceptualScale = clamp(Number(snapshot.conceptScale || "1.50"), 1.0, 2.0);

  const baseW = snapshot.derivedSize?.w ?? derivedSize.w;
  const baseH = snapshot.derivedSize?.h ?? derivedSize.h;
  const finalW = refineOn ? Math.max(1, Math.round(baseW * conceptualScale)) : baseW;
  const finalH = refineOn ? Math.max(1, Math.round(baseH * conceptualScale)) : baseH;

  const sizeLabel = `${finalW}x${finalH}`;
  const ps = currentPromptSettings();
  const posRaw = ps.trimTrailingComma ? trimTrailingComma(String(snapshot.positivePrompt || "").trim()) : String(snapshot.positivePrompt || "").trim();
  const negRaw = ps.trimTrailingComma ? trimTrailingComma(String(snapshot.negativePrompt || "").trim()) : String(snapshot.negativePrompt || "").trim();
  const pos2Raw = ps.trimTrailingComma ? trimTrailingComma(String(snapshot.positivePrompt2 || "").trim()) : String(snapshot.positivePrompt2 || "").trim();
  const neg2Raw = ps.trimTrailingComma ? trimTrailingComma(String(snapshot.negativePrompt2 || "").trim()) : String(snapshot.negativePrompt2 || "").trim();

  snapshot.positivePrompt = posRaw;
  snapshot.negativePrompt = negRaw;
  snapshot.positivePrompt2 = pos2Raw;
  snapshot.negativePrompt2 = neg2Raw;

  const promptText = buildPromptText(posRaw);
  const seedLabel = String(seedResolved);

  const record = renderCardFromSnapshot(snapshot, sizeLabel, promptText, seedLabel);
  pendingJobs.push(record);
  refreshFooterMeta();

  if(runNow) pumpQueue();
}

function renderCardFromSnapshot(snapshot, sizeLabel, promptText, seedLabel){
  const record = renderCardModel({
    id: crypto.randomUUID(),
    stage: "queued",
    progress: "",
    promptText,
    sizeLabel,
    seedLabel,
    previewUrl: "",
    finalUrl: "",
    promptId: "",
    secondPassEnabled: !!snapshot.enableSecondPass,
    snapshot
  });
  galleryRecords.unshift(record);
  renderGallery();
  return record;
}

function renderCardModel(model){
  return makeGalleryCard(model);
}

async function pumpQueue(){
  if(activeJob) return;
  if(!pendingJobs.length){
    setRunState("", "idle", "");
    $("stopBtn").disabled = true;
    refreshFooterMeta();
    return;
  }

  const next = pendingJobs.shift();
  activeJob = next;
  $("stopBtn").disabled = false;

  refreshFooterMeta();
  ensureWebsocket();

  applySnapshot(next.snapshot);

  const seed = Number(next.snapshot.seedResolved) || randomSeed();
  const wf = buildWorkflowGraph(seed);

  next.secondPassEnabled = wf.secondPassEnabled;

  try{
    next.stageText.textContent = "running";
    next.progressText.textContent = "";
    setRunState("warn","running","");

    const reply = await queuePrompt(wf.graph);
    const promptId = reply?.prompt_id;
    if(!promptId) throw new Error("missing prompt_id");

    next.promptId = promptId;
    setRunState("warn","running", promptId);

    const startTime = Date.now();
    while(activeJob === next){
      await sleep(450);
      const entry = await fetchHistory(promptId).catch(()=>null);
      if(entry){
        const preview = imageUrlFromHistory(entry, "12");
        const final = imageUrlFromHistory(entry, "21");

        if(preview && !next.previewUrl){
          next.previewUrl = preview;
          next.imageNode.src = preview;
          next.stageText.textContent = next.secondPassEnabled ? "1st pass" : "final";
          if(!next.secondPassEnabled) break;
        }

        if(final){
          next.finalUrl = final;
          next.imageNode.src = final;
          next.stageText.textContent = "final";
          break;
        }
      }
      if(Date.now() - startTime > 240000) break;
    }

    if(activeJob === next){
      completeJob(next, true);
    }

  }catch(e){
    if(activeJob === next){
      next.stageText.textContent = "error";
      next.progressText.textContent = "";
      setRunState("bad","error", e.message || String(e));
      activeJob = null;
      $("stopBtn").disabled = true;
      refreshFooterMeta();
      pumpQueue();
    }
  }
}

function completeJob(record, ok){
  if(ok){
    setRunState("ok","done", record.promptId || "");
    record.stageText.textContent = record.secondPassEnabled ? "final" : (record.previewUrl ? "final" : "done");
  }else{
    setRunState("warn","stopped", record.promptId || "");
    record.stageText.textContent = "stopped";
  }
  record.progressText.textContent = "";
  activeJob = null;
  $("stopBtn").disabled = true;
  refreshFooterMeta();
  pumpQueue();
}

async function stopActive(){
  if(!activeJob) return;
  await interruptBackend();
  completeJob(activeJob, false);
}

async function readSystemStats(){
  try{
    const stats = await apiGet("/system_stats");
    return stats;
  }catch(_){
    return null;
  }
}

function formatBytesGb(bytes){
  const gb = bytes / (1024*1024*1024);
  if(!Number.isFinite(gb)) return "--";
  return `${gb.toFixed(1)} GB`;
}

function pickGpuVram(stats){
  const devices = stats?.devices;
  if(Array.isArray(devices) && devices.length){
    const cuda = devices.find(d => String(d?.type || "").toLowerCase().includes("cuda")) || devices[0];
    const total = Number(cuda?.vram_total) || Number(cuda?.vramTotal) || Number(cuda?.total_vram) || Number(cuda?.totalVram) || 0;
    const free = Number(cuda?.vram_free) || Number(cuda?.vramFree) || Number(cuda?.free_vram) || Number(cuda?.freeVram) || 0;
    const used = total && free ? (total - free) : Number(cuda?.vram_used) || Number(cuda?.vramUsed) || 0;
    return { total, free, used };
  }

  const total = Number(stats?.vram_total) || Number(stats?.vramTotal) || 0;
  const free = Number(stats?.vram_free) || Number(stats?.vramFree) || 0;
  const used = total && free ? (total - free) : Number(stats?.vram_used) || Number(stats?.vramUsed) || 0;
  return { total, free, used };
}

function updateVramUi(total, used){
  const textNode = $("vramText");
  const fill = $("vramFill");
  const note = $("vramNote");
  const purgeBtn = $("purgeVramBtn");

  if(!total || !Number.isFinite(total) || total <= 0){
    if(textNode) textNode.textContent = "--";
    fill.style.width = "0%";
    fill.classList.remove("hot");
    note.textContent = "--";
    note.className = "note";
    if(purgeBtn) purgeBtn.classList.remove("cache-clear");
    return;
  }

  const ratio = clamp(used / total, 0, 1);
  const pct = ratio * 100;

  if(textNode) textNode.textContent = "usage";
  fill.style.width = `${pct.toFixed(0)}%`;
  fill.classList.toggle("hot", pct >= 90);

  note.textContent = `${formatBytesGb(used)} / ${formatBytesGb(total)}`;
  if(purgeBtn) purgeBtn.classList.toggle("cache-clear", ratio <= 0.1);

  const cls = pct >= 92 ? "vrambad" : pct >= 80 ? "vramwarn" : "vramok";
  note.className = `note ${cls}`;
}

async function pollSystemStats(){
  while(true){
    if(backendConnected){
      const stats = await readSystemStats();
      if(stats){
        const v = pickGpuVram(stats);
        updateVramUi(v.total, v.used);
      }
    }
    await sleep(1200);
  }
}

async function purgeVram(){
  if(!backendConnected){ toast("not connected"); return; }
  try{
    await apiPost("/free", {});
    toast("purged");
    await sleep(300);
    const stats = await readSystemStats();
    if(stats){
      const v = pickGpuVram(stats);
      updateVramUi(v.total, v.used);
    }
  }catch(e){
    toast("purge failed");
  }
}

function bindControls(){
  $("openSettings").addEventListener("click", toggleSettingsDrawer);

  $("connectBtn").addEventListener("click", async ()=>{
    const ok = await pingBackend();
    if(ok){
      await loadCheckpoints();
      ensureWebsocket();
      toast("connected");
    }
  });

  $("baseUrl").addEventListener("input", ()=>{ refreshBaseBadge(); markSettingsDirty(); });

  $("themeSelect").addEventListener("change", (ev)=>{ applyTheme(ev.target.value); markSettingsDirty(); });
  $("settingsSaveBtn").addEventListener("click", saveSettings);

  // Prompt options
  for(const id of ["optUseTokenCounter","optShowTokenAlert","optUseAutocomplete","optUseWiki","optTrimTrailingComma"]){
    $(id).addEventListener("change", ()=>{ markSettingsDirty(); updatePromptsSettingsUi(); });
  }
  $("optTagBlacklist").addEventListener("input", ()=>{ markSettingsDirty(); });

  // Sizing options
  $("mpTolerance").addEventListener("input", ()=>{ updateAdvSizingBadge(); updateTargetMpWarn(); markSettingsDirty(); updateDerivedSizeFromSketch(); });
  $("targetMp").addEventListener("input", ()=>{ updateAdvSizingBadge(); updateTargetMpWarn(); markSettingsDirty(); updateDerivedSizeFromSketch(); });

  // Storage
  $("storageResetBtn").addEventListener("click", resetStorage);


  $("purgeVramBtn").addEventListener("click", purgeVram);

  $("resetSketch").addEventListener("click", resetSketch);

  $("toggleSizeSection").addEventListener("click", ()=>{
    const body = $("sizeSectionBody");
    const collapsed = body.style.display !== "none";
    setSectionCollapsed("toggleSizeSection", "sizeSectionBody", collapsed);
    localStorage.setItem("bumfy_collapse_size", collapsed ? "1" : "0");
  });

  $("toggleModelSettings").addEventListener("click", ()=>{
    const body = $("modelSettingsBody");
    const collapsed = body.style.display !== "none";
    setSectionCollapsed("toggleModelSettings", "modelSettingsBody", collapsed);
    localStorage.setItem("bumfy_collapse_model", collapsed ? "1" : "0");
  });

  $("customSizeEnabled").addEventListener("change", updateDerivedSizeFromSketch);
  $("customWidth").addEventListener("input", ()=>{ if($("customSizeEnabled").checked) updateDerivedSizeFromSketch(); });
  $("customHeight").addEventListener("input", ()=>{ if($("customSizeEnabled").checked) updateDerivedSizeFromSketch(); });

  $("enableSecondPass").addEventListener("change", syncRefineVisibility);
  $("editSecondPrompts").addEventListener("change", syncRefineVisibility);
  $("enableUpscale").addEventListener("change", ()=>{ syncRefineVisibility(); updateSizeBadges(); });
  $("conceptScale").addEventListener("input", updateSizeBadges);

  $("seedMode").addEventListener("change", syncSeedMode);
  $("randomizeSeedBtn").addEventListener("click", ()=>{
    $("seedValue").value = String(randomSeed());
    updateSizeBadges();
  });

  $("batchSize").addEventListener("input", updateSizeBadges);

  $("checkpointName").addEventListener("change", ()=>{
    refreshModelBadge();
    setQualityPresetSelect();
    refreshSamplerSchedulerBadge();
  });

  $("samplerName").addEventListener("change", refreshSamplerSchedulerBadge);
  $("schedulerName").addEventListener("change", refreshSamplerSchedulerBadge);

  $("saveQualityPresetBtn").addEventListener("click", savePresetFromPrompt);
  $("loadQualityPresetBtn").addEventListener("click", loadSelectedPreset);
  $("clearQualityPresetBtn").addEventListener("click", clearAppliedTags);

  $("generateBtn").addEventListener("click", ()=>{
    enqueueJob(null, true);
    if(!activeJob) refreshFooterMeta();
  });

  $("stopBtn").addEventListener("click", stopActive);

  $("clearGalleryBtn").addEventListener("click", ()=>{
    galleryRecords = [];
    renderGallery();
  });

  document.addEventListener("keydown", (ev)=>{
    if(ev.key === "Enter" && ev.ctrlKey && ev.altKey){
      ev.preventDefault();
      if(!$("stopBtn").disabled) stopActive();
      return;
    }
    if(ev.key === "Enter" && ev.ctrlKey){
      ev.preventDefault();
      enqueueJob(null, true);
      if(!activeJob) refreshFooterMeta();
      return;
    }
    if(ev.key === "Escape"){
      closeSettingsDrawer();
    }
  });
}

function syncBadgesTop(){
  refreshModelBadge();
  refreshSamplerSchedulerBadge();
  updateSizeBadges();
}

function initDefaults(){
  $("seedMode").value = "random";
  $("samplerName").value = "er_sde";
  $("schedulerName").value = "kl_optimal";
  $("steps1").value = "24";
  $("cfg1").value = "6";
  $("steps2").value = "18";
  $("cfg2").value = "6";
  $("denoise2").value = "0.52";
  $("batchSize").value = "1";
  $("conceptScale").value = "1.50";
  $("enableUpscale").checked = true;
  $("enableSecondPass").checked = false;
  $("editSecondPrompts").checked = false;
  $("customSizeEnabled").checked = false;
  appliedQualityTagText = "";
  refreshQualityBadge();

  window.addEventListener("resize", ()=>{
    syncFrameInfoHeight();
    resizeAspectCanvas();
    drawAspectCanvas();
  });
}

async function init(){
  initDefaults();
  restoreSettings();

  loadSamplerChoices();
  loadSchedulerChoices();

    bindSplitResizer();
    bindControls();
    attachCanvasEvents();
    setupTagAutocomplete($("positivePrompt"));
    setupTagAutocomplete($("negativePrompt"));
    setupTagAutocomplete($("positivePrompt2"));
    setupTagAutocomplete($("negativePrompt2"));
    await setupPromptTokenCounters();

  setBackendState("", "disconnected", "");
  setRunState("", "idle", "");

  drawAspectCanvas();
  updateDerivedSizeFromSketch();
  syncRefineVisibility();
  syncSeedMode();

  $("baseBadge").textContent = baseUrl();

  const ok = await pingBackend();
  if(ok){
    ensureWebsocket();
    await loadCheckpoints();
  }else{
    await loadCheckpoints().catch(()=>{});
  }

  setQualityPresetSelect();

  syncBadgesTop();
  renderGallery();
  refreshFooterMeta();

  pollSystemStats();
}
init();

})();
</script>
</body>
</html>
